<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueQuiz - Tạo và Chấm Điểm</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23667eea'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'>Q</text></svg>">
    <!-- Libraries for file import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --card-bg: #f8f9fa;
            --border-color: #ddd;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --correct-bg: #d4edda;
            --correct-text: #155724;
            --incorrect-bg: #f8d7da;
            --incorrect-text: #721c24;
            --filter-bg: #f0f4ff;
            --ai-prompts-bg-start: #a8edea;
            --ai-prompts-bg-end: #fed6e3;
            --template-bg: rgba(255, 255, 255, 0.5);
            --template-item-bg: #ffffff;
            --prompt-card-bg: #ffffff;
            --prompt-text-bg: #f8f9fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #667eea;
            --accent-color-light: #8b9efc;
        }

        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #b8b8b8;
            --card-bg: #1a1a2e;
            --border-color: #2d4356;
            --input-bg: #16213e;
            --input-border: #2d4356;
            --correct-bg: #1e4620;
            --correct-text: #4caf50;
            --incorrect-bg: #4a1c1c;
            --incorrect-text: #ff6b6b;
            --filter-bg: #1a1a2e;
            --ai-prompts-bg-start: #16213e;
            --ai-prompts-bg-end: #1a1a2e;
            --template-bg: rgba(26, 26, 46, 0.5);
            --template-item-bg: #16213e;
            --prompt-card-bg: #1a1a2e;
            --prompt-text-bg: #16213e;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --accent-color: #8b9efc;
            --accent-color-light: #a8b5ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .language-buttons {
            display: flex;
            gap: 5px;
        }

        .language-button {
            padding: 8px 15px;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .language-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .language-button.active {
            background: rgba(76, 175, 80, 0.8);
            border-color: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
            transition: border-color 0.3s, background 0.3s, color 0.3s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .hint {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
            font-style: italic;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 20px;
        }

        .quiz-settings-group {
            width: 100%;
            background: var(--template-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-row label:first-child {
            font-weight: 600;
            min-width: 110px;
            color: var(--text-primary);
        }

        .hint-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
        }

        .radio-label input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .radio-label:hover {
            color: var(--accent-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        /* File upload styles */
        .upload-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .file-upload-btn {
            /* Reset all default styles */
            margin: 0;
            padding: 0;
            border: none;
            background: none;
            font: inherit;

            /* Common button styles */
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 9px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            white-space: nowrap;
            text-decoration: none;
            vertical-align: middle;
        }

        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .file-upload-btn input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        .file-info {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #quizContainer {
            margin-top: 30px;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .question-header {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .question-text {
            margin-bottom: 15px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--accent-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .question-image:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            cursor: pointer;
        }

        body.dark-mode .question-image {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-color-light);
        }

        body.dark-mode .question-image:hover {
            box-shadow: 0 6px 20px rgba(139, 158, 252, 0.4);
        }

        /* Image Lightbox Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.95);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #667eea;
        }

        /* Pause Timer Button */
        .pause-timer-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            width: 100%;
        }

        .pause-timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pause-timer-btn:active {
            transform: translateY(0);
        }

        body.dark-mode .pause-timer-btn {
            background: linear-gradient(135deg, #8b9efc 0%, #9f7aea 100%);
        }

        .options {
            margin-left: 20px;
        }

        .option {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option input[type="radio"],
        .option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .option input[type="radio"]:disabled,
        .option input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .option input[type="radio"]:disabled + label,
        .option input[type="checkbox"]:disabled + label {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Highlight checked options after grading */
        .option input[type="radio"]:checked:disabled + label,
        .option input[type="checkbox"]:checked:disabled + label {
            background: rgba(102, 126, 234, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            opacity: 1;
            font-weight: 600;
        }

        body.dark-mode .option input[type="radio"]:checked:disabled + label,
        body.dark-mode .option input[type="checkbox"]:checked:disabled + label {
            background: rgba(139, 158, 252, 0.3);
            color: var(--accent-color-light);
            opacity: 1;
        }

        .option label {
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        .result-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
        }

        .result-section h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
        }

        .result-details {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 30px;
            border-radius: 10px;
        }

        .result-item h3 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .result-item p {
            font-size: 2em;
            font-weight: bold;
        }

        .question-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .question-result.correct {
            background: var(--correct-bg);
            color: var(--correct-text);
        }

        .question-result.incorrect {
            background: var(--incorrect-bg);
            color: var(--incorrect-text);
        }

        .hidden {
            display: none;
        }

        .pin-button {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            margin-left: 10px;
            transition: all 0.3s;
            text-transform: none;
            letter-spacing: normal;
        }

        .pin-button:hover {
            transform: scale(1.2);
        }

        .pin-button.pinned {
            color: #ffd700;
        }

        .pin-button.unpinned {
            color: #ccc;
        }

        .question-card.pinned {
            border-left-color: #ffd700;
            background: #fffdf0;
        }

        body.dark-mode .question-card.pinned {
            border-left-color: #f59e0b;
            background: #422006;
        }

        .question-header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--filter-bg);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: 600;
        }

        .filter-button:hover {
            background: #667eea;
            color: white;
        }

        .filter-button.active {
            background: #667eea;
            color: white;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-bar-bg {
            width: 100%;
            height: 24px;
            background: var(--input-border);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 0.3s ease;
            width: 0%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .ai-prompts-section {
            background: linear-gradient(135deg, var(--ai-prompts-bg-start) 0%, var(--ai-prompts-bg-end) 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            transition: background 0.3s ease;
        }

        .ai-prompts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .ai-prompts-header h3 {
            font-size: 1.2em;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .ai-prompts-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .ai-prompts-content.expanded {
            max-height: 99999px;
            margin-top: 20px;
        }

        .ai-prompts-content p {
            color: var(--text-primary);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .prompt-card {
            background: var(--prompt-card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .prompt-card h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .prompt-card p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .quick-templates-title {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .prompt-text {
            background: var(--prompt-text-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .copy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .quick-templates {
            background: var(--template-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .template-item {
            background: var(--template-item-bg);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .template-label {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .template-box {
            background: var(--prompt-text-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8em;
            line-height: 1.5;
            color: var(--text-primary);
            white-space: pre-wrap;
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .exam-mode-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timer-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-input-group input {
            width: 80px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .timer-input-group label {
            color: var(--text-primary);
            font-weight: 600;
            margin: 0;
        }

        body.dark-mode .timer-input-group input {
            border: 2px solid var(--accent-color-light);
            background: rgba(26, 26, 46, 0.8);
            color: #e5e7eb;
        }

        body.dark-mode .timer-input-group label {
            color: #e5e7eb;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Quiz Management Styles */
        .quiz-management {
            background: linear-gradient(135deg, #7f7fd5 0%, #86a8e7 50%, #91eae4 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .quiz-management h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .quiz-save-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quiz-save-section input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 1em;
        }

        .quiz-save-section button {
            background: rgba(255, 255, 255, 0.9);
            color: #7f7fd5;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-save-section button:hover {
            background: white;
            transform: translateY(-2px);
        }

        .saved-quizzes-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .saved-quiz-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .saved-quiz-item:last-child {
            margin-bottom: 0;
        }

        .saved-quiz-info {
            flex: 1;
            color: #333;
        }

        .saved-quiz-name {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .saved-quiz-meta {
            font-size: 0.85em;
            color: #666;
        }

        .saved-quiz-actions {
            display: flex;
            gap: 8px;
        }

        .btn-load, .btn-delete {
            padding: 6px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-load {
            background: #4caf50;
            color: white;
        }

        .btn-load:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #da190b;
        }

        /* Statistics Styles */
        .stats-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .stats-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .statistics-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .statistics-section h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .history-table td {
            color: var(--text-primary);
        }

        .history-table tr:hover {
            background: var(--filter-bg);
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .score-excellent {
            background: #4caf50;
            color: white;
        }

        .score-good {
            background: #8bc34a;
            color: white;
        }

        .score-average {
            background: #ffc107;
            color: #333;
        }

        .score-poor {
            background: #ff5722;
            color: white;
        }

        .clear-history-btn {
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .clear-history-btn:hover {
            background: #da190b;
        }

        /* Question Navigator Sidebar */
        .quiz-layout {
            position: relative;
        }

        .question-navigator {
            position: fixed;
            left: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 5px 0 20px var(--shadow-color);
            transition: transform 0.3s ease, background 0.3s ease;
            overflow-y: auto;
            z-index: 1000;
            transform: translateX(-100%);
        }

        .question-navigator.active {
            display: block;
        }

        .question-navigator.open {
            transform: translateX(0);
        }

        .quiz-main-content {
            margin-left: 0;
        }

        .navigator-header {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navigator-close-btn {
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-primary);
            transition: color 0.3s, transform 0.3s;
            user-select: none;
        }

        .navigator-close-btn:hover {
            color: var(--accent-color);
            transform: scale(1.2);
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle-btn {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 999;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: none;
        }

        .sidebar-toggle-btn.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: scale(1.05);
        }

        body.dark-mode .sidebar-toggle-btn {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--accent-color-light);
        }

        /* Focus Mode Button */
        .focus-mode-btn {
            position: fixed;
            left: 80px;
            top: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 999;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: none;
        }

        .focus-mode-btn.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .focus-mode-btn:hover {
            background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
            transform: scale(1.05);
        }

        .focus-mode-btn.focused {
            background: linear-gradient(135deg, #ff5722 0%, #ff9800 100%);
        }

        body.dark-mode .focus-mode-btn {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #38ef7d;
        }

        /* Focus Mode - Hide elements */
        body.focus-mode .question-navigator,
        body.focus-mode .fixed-right-timer,
        body.focus-mode .fixed-control-panel,
        body.focus-mode .progress-container {
            display: none !important;
        }

        .navigator-content {
            overflow: hidden;
        }

        /* Fixed Right Timer Panel */
        .fixed-right-timer {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 280px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: background 0.3s ease;
            z-index: 100;
            display: none;
        }

        .fixed-right-timer.active {
            display: block;
        }

        .timer-panel-header {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
        }

        .timer-display-box {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 30px 20px;
            border-radius: 10px;
            text-align: center;
            border: 3px solid #f0c000;
        }

        body.dark-mode .timer-display-box {
            background: linear-gradient(135deg, #2d3436 0%, #1a1a2e 100%);
            border-color: #4a5568;
        }

        .fixed-timer-text {
            font-size: 2.5em;
            font-weight: bold;
            color: #1a1a2e;
            margin: 0;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        body.dark-mode .fixed-timer-text {
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        .fixed-timer-text.warning {
            color: #d97706;
        }

        body.dark-mode .fixed-timer-text.warning {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        .fixed-timer-text.danger {
            color: #dc2626;
            animation: pulse 0.5s infinite;
        }

        body.dark-mode .fixed-timer-text.danger {
            color: #f87171;
            text-shadow: 0 0 20px rgba(248, 113, 113, 0.6);
        }

        .fixed-timer-label {
            color: #374151;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        body.dark-mode .fixed-timer-label {
            color: #9ca3af;
        }

        .question-nav-list {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .question-nav-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .question-nav-item:hover {
            transform: scale(1.05);
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .question-nav-item.answered {
            background: #2196f3;
            border-color: #1976d2;
            color: white;
        }

        body.dark-mode .question-nav-item.answered {
            background: #1e40af;
            border-color: #3b82f6;
            color: #e0f2fe;
        }

        .question-nav-item.correct {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }

        body.dark-mode .question-nav-item.correct {
            background: #15803d;
            border-color: #22c55e;
            color: #dcfce7;
        }

        .question-nav-item.incorrect {
            background: #ff5722;
            border-color: #ff5722;
            color: white;
        }

        body.dark-mode .question-nav-item.incorrect {
            background: #b91c1c;
            border-color: #ef4444;
            color: #fee2e2;
        }

        .question-nav-item.current {
            border-color: #667eea;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .question-nav-item.pinned {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-color: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
        }

        body.dark-mode .question-nav-item.pinned {
            background: linear-gradient(135deg, #b45309 0%, #d97706 100%);
            border-color: #f59e0b;
            color: #fef3c7;
        }

        .question-nav-item.pinned.answered {
            background: linear-gradient(135deg, #ffd700 0%, #4ade80 100%);
            color: #1a1a2e;
        }

        body.dark-mode .question-nav-item.pinned.answered {
            background: linear-gradient(135deg, #b45309 0%, #15803d 100%);
            border-color: #22c55e;
            color: #dcfce7;
        }

        /* Fixed Control Panel - Bottom Right */
        .fixed-control-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 280px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: background 0.3s ease;
            z-index: 100;
            display: none;
        }

        .fixed-control-panel.active {
            display: block;
        }

        .control-panel-header {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
        }

        .navigator-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-nav {
            width: 100%;
            padding: 12px;
            font-size: 0.95em;
            border-radius: 8px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            /* Container & Layout */
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 15px;
            }

            /* Template Grid */
            .template-grid {
                grid-template-columns: 1fr;
            }

            /* Sidebar Navigation */
            .question-navigator {
                width: 85% !important;
                max-width: 300px;
                transform: translateX(-100%);
                padding: 15px;
            }

            .question-navigator.open {
                transform: translateX(0) !important;
            }

            .sidebar-toggle-btn {
                left: 10px !important;
                top: 10px !important;
                width: 45px !important;
                height: 45px !important;
                min-width: 45px !important;
                max-width: 45px !important;
                min-height: 45px !important;
                max-height: 45px !important;
                font-size: 1.3em;
            }

            .quiz-main-content {
                margin-left: 0 !important;
            }

            .question-nav-list {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }

            .question-nav-item {
                min-width: 45px;
                height: 45px;
                font-size: 0.95em;
            }

            /* Fixed Panels - Make them static on mobile */
            .fixed-right-timer {
                position: relative !important;
                right: auto !important;
                top: auto !important;
                width: auto !important;
                max-width: 100%;
                margin: 0 auto 20px auto;
            }

            .fixed-control-panel {
                position: relative !important;
                right: auto !important;
                bottom: auto !important;
                width: auto !important;
                max-width: 100%;
                margin: 20px auto 0 auto;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5em;
                margin-top: 60px;
            }

            .header p {
                font-size: 0.9em;
            }

            .language-selector {
                position: relative;
                top: auto;
                right: auto;
                flex-direction: column;
                gap: 8px;
                width: 100%;
                margin-bottom: 15px;
            }

            .language-buttons {
                width: 100%;
                justify-content: center;
            }

            .language-button {
                flex: 1;
                font-size: 0.85em;
                padding: 6px 12px;
            }

            .theme-toggle {
                width: 100%;
                justify-content: center;
                font-size: 1em;
                padding: 6px 12px;
            }

            /* Buttons - Larger touch targets */
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            button:not(.pin-button):not(.filter-button):not(.language-button):not(.theme-toggle) {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 1em;
            }

            button:not(.pin-button):not(.filter-button):not(.sidebar-toggle-btn):not(.scroll-to-top) {
                width: 100%;
            }

            .question-header-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .upload-container {
                flex-direction: column;
                align-items: stretch;
            }

            .file-upload-btn {
                width: 100%;
                justify-content: center;
            }

            .setting-row {
                flex-wrap: wrap;
            }

            .radio-group {
                flex-wrap: wrap;
                gap: 12px;
            }
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
            border-top: 3px solid rgba(255, 255, 255, 0.1);
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .footer p {
            margin: 10px 0;
            font-size: 1em;
        }

        .footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.3s, transform 0.2s;
            display: inline-block;
        }

        .footer a:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        .footer .separator {
            margin: 0 15px;
            opacity: 0.5;
        }

        body.dark-mode .footer {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-top-color: rgba(139, 158, 252, 0.2);
        }

        body.dark-mode .footer a {
            color: var(--accent-color-light);
        }

        /* Scroll to Top Button - Mobile Only */
        .scroll-to-top {
            display: none !important; /* Hidden on desktop */
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            align-items: center;
            justify-content: center;
        }

        .scroll-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        body.dark-mode .scroll-to-top {
            background: linear-gradient(135deg, #8b9efc 0%, #a8b5ff 100%);
            box-shadow: 0 4px 15px rgba(139, 158, 252, 0.4);
        }

        body.dark-mode .scroll-to-top:hover {
            box-shadow: 0 6px 20px rgba(139, 158, 252, 0.6);
        }

        /* Mobile-specific scroll to top button */
        @media (max-width: 768px) {
            .scroll-to-top {
                display: none; /* Can be shown with .show class */
                bottom: 20px !important;
                right: 20px !important;
                width: 45px !important;
                height: 45px !important;
                min-width: 45px !important;
                max-width: 45px !important;
                min-height: 45px !important;
                max-height: 45px !important;
                font-size: 1.3em;
            }

            .scroll-to-top.show {
                display: flex !important; /* Show on mobile when scrolled */
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Right Timer Panel -->
    <div class="fixed-right-timer" id="fixedRightTimer">
        <div class="timer-panel-header" data-i18n="timerPanelHeader">⏱️ Thời Gian</div>
        <div class="timer-display-box">
            <div class="fixed-timer-label" data-i18n="timeRemaining">Thời gian còn lại:</div>
            <div class="fixed-timer-text" id="fixedTimerText">00:30:00</div>
        </div>
        <button class="pause-timer-btn" id="pauseTimerBtn" onclick="togglePauseTimer()" style="display: none;">
            <span id="pauseIcon">⏸️</span> <span id="pauseText" data-i18n="pauseTimer">Tạm dừng</span>
        </button>
    </div>

    <!-- Fixed Control Panel - Bottom Right -->
    <div class="fixed-control-panel" id="fixedControlPanel">
        <div class="control-panel-header" data-i18n="controlPanelHeader">🎮 Điều Khiển</div>
        <div class="navigator-controls">
            <button class="btn-success btn-nav" onclick="submitQuiz()" data-i18n="submitBtn">Chấm Điểm</button>
            <button class="btn-secondary btn-nav" onclick="backToEdit()" data-i18n="backToEditBtn">⬅️ Quay Lại</button>
            <button class="btn-secondary btn-nav" onclick="restartQuiz()" data-i18n="restartBtn">🔄 Làm Lại</button>
            <button class="btn-primary btn-nav hidden" id="retryAllBtn" onclick="retryAllQuestions()" data-i18n="retryAllBtn">🔄 Làm Lại Tất Cả</button>
            <button class="btn-warning btn-nav hidden" id="retryIncorrectBtn" onclick="retryIncorrectQuestions()" data-i18n="retryIncorrectBtn">Làm Lại Câu Sai</button>
            <button class="btn-info btn-nav hidden" id="retryPinnedBtn" onclick="retryPinnedQuestions()" data-i18n="retryPinnedBtn">Làm Lại Câu Đã Pin</button>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modalImage" onclick="event.stopPropagation()">
    </div>

    <div class="container">
        <div class="header">
            <div class="language-selector">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle dark mode">
                    🌙
                </button>
                <div class="language-buttons">
                    <button class="language-button active" id="langVi" onclick="changeLanguage('vi')">🇻🇳 VI</button>
                    <button class="language-button" id="langEn" onclick="changeLanguage('en')">🇬🇧 EN</button>
                </div>
            </div>
            <h1 data-i18n="title">📝 BlueQuiz</h1>
            <p data-i18n="subtitle">Tạo bộ câu hỏi, xáo trộn và chấm điểm tự động</p>
        </div>

        <div class="content">
            <!-- AI Prompts Section -->
            <div class="ai-prompts-section">
                <div class="ai-prompts-header" onclick="toggleAIPrompts()">
                    <h3>
                        <span>🤖</span>
                        <span data-i18n="aiPromptsTitle">Hướng Dẫn Tạo Câu Hỏi Với AI Chatbot</span>
                    </h3>
                    <span class="toggle-icon" id="toggleIcon">▼</span>
                </div>
                <div class="ai-prompts-content" id="aiPromptsContent">
                    <p data-i18n="aiPromptsDesc">Copy các prompt sau và paste vào ChatGPT, Claude, hoặc AI chatbot khác để tự động tạo câu hỏi đúng format:</p>

                    <!-- Quick Copy Templates -->
                    <div class="quick-templates">
                        <h4 class="quick-templates-title" data-i18n="quickTemplatesTitle">📋 Hoặc Copy Template Mẫu Để Paste Trực Tiếp:</h4>

                        <div class="template-grid">
                            <div class="template-item">
                                <div class="template-label" data-i18n="templateQuestionsLabel">Mẫu Câu Hỏi:</div>
                                <div class="template-box" id="questionsTemplate">1. Câu hỏi thứ nhất?
a. Đáp án A
b. Đáp án B
c. Đáp án C
d. Đáp án D

2. Câu hỏi thứ hai?
a. Đáp án A
b. Đáp án B
c. Đáp án C
d. Đáp án D

3. Câu hỏi thứ ba (nhiều đáp án đúng)?
a. Lựa chọn A
b. Lựa chọn B
c. Lựa chọn C
d. Lựa chọn D
e. Lựa chọn E</div>
                                <button class="copy-btn" onclick="copyTemplate('questions')" id="copyQuestionsBtn">
                                    <span data-i18n="copyBtn">Copy</span>
                                </button>
                            </div>

                            <div class="template-item">
                                <div class="template-label" data-i18n="templateAnswersLabel">Mẫu Đáp Án:</div>
                                <div class="template-box" id="answersTemplate">1. a
2. b
3. a,c,e</div>
                                <button class="copy-btn" onclick="copyTemplate('answers')" id="copyAnswersBtn">
                                    <span data-i18n="copyBtn">Copy</span>
                                </button>
                            </div>

                            <div class="template-item">
                                <div class="template-label" data-i18n="templateListItemsLabel">Mẫu List Items:</div>
                                <div class="template-box" id="listItemsTemplate">Các hoạt động nào sau đây là chính trong quy trình review?
- 1. Lập kế hoạch
- 2. Review cá nhân
- 3. Họp nhóm
- 4. Sửa lỗi
- 5. Tài liệu hóa
- 6. Kiểm thử

A. 1, 2, 4
B. 2, 3, 5
C. 1, 2, 3, 4
D. Tất cả các mục</div>
                                <button class="copy-btn" onclick="copyTemplate('listItems')" id="copyListItemsBtn">
                                    <span data-i18n="copyBtn">Copy</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 25px 0; border: none; border-top: 1px solid #ddd;">

                    <div id="promptsContainer"></div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="section" id="inputSection">
                <h2 class="section-title" data-i18n="step1">Bước 1: Nhập Dữ Liệu</h2>

                <!-- Quiz Management -->
                <div class="quiz-management">
                    <h3>💾 <span data-i18n="quizManagement">Quản Lý Bộ Quiz</span></h3>
                    <div class="quiz-save-section">
                        <input type="text" id="quizNameInput" data-i18n-placeholder="quizNamePlaceholder" placeholder="Nhập tên bộ quiz (VD: Lịch Sử Việt Nam, JavaScript Basics...)">
                        <button onclick="saveQuizSet()" data-i18n="saveQuizBtn">💾 Lưu Bộ Quiz</button>
                    </div>
                    <div class="saved-quizzes-list" id="savedQuizzesList">
                        <!-- Saved quizzes will appear here -->
                    </div>
                </div>

                <div class="input-group">
                    <label for="questionsInput" data-i18n="questionsLabel">Câu hỏi và đáp án:</label>
                    <textarea id="questionsInput" rows="12" data-i18n-placeholder="questionsPlaceholder"></textarea>
                    <div class="upload-container">
                        <label class="file-upload-btn">
                            📁 <span data-i18n="importFileBtn">Import từ file</span>
                            <input type="file" id="questionsFileInput" accept=".xlsx,.xls,.docx,.txt" onchange="handleQuestionsFileUpload(event)">
                        </label>
                        <label class="file-upload-btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            🖼️ <span data-i18n="addImageBtn">Thêm ảnh</span>
                            <input type="file" id="imageFileInput" accept="image/*" onchange="handleImageUpload(event)" multiple style="display: none;">
                        </label>
                        <button class="file-upload-btn" onclick="exportQuestions('txt')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            💾 <span data-i18n="exportTxtBtn">Export TXT</span>
                        </button>
                        <button class="file-upload-btn" onclick="exportQuestions('xlsx')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            💾 <span data-i18n="exportExcelBtn">Export Excel</span>
                        </button>
                        <span class="file-info" id="questionsFileInfo"></span>
                    </div>
                    <p class="hint" data-i18n="questionsHint">Mỗi câu hỏi bắt đầu bằng số thứ tự, các đáp án bắt đầu bằng a, b, c, d...</p>
                    <p class="upload-hint" data-i18n="uploadHint">Hỗ trợ: Excel (.xlsx, .xls), Word (.docx), Text (.txt)</p>
                    <p class="upload-hint" data-i18n="imageHint">Thêm ảnh: Chọn ảnh từ máy tính, tag [IMG:...] sẽ được thêm vào vị trí con trỏ</p>
                </div>

                <div class="input-group">
                    <label for="answersInput" data-i18n="answersLabel">Đáp án đúng:</label>
                    <textarea id="answersInput" rows="6" data-i18n-placeholder="answersPlaceholder"></textarea>
                    <div class="upload-container">
                        <label class="file-upload-btn">
                            📁 <span data-i18n="importFileBtn">Import từ file</span>
                            <input type="file" id="answersFileInput" accept=".xlsx,.xls,.docx,.txt" onchange="handleAnswersFileUpload(event)">
                        </label>
                        <button class="file-upload-btn" onclick="exportAnswers('txt')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            💾 <span data-i18n="exportTxtBtn">Export TXT</span>
                        </button>
                        <button class="file-upload-btn" onclick="exportAnswers('xlsx')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            💾 <span data-i18n="exportExcelBtn">Export Excel</span>
                        </button>
                        <span class="file-info" id="answersFileInfo"></span>
                    </div>
                    <p class="hint" data-i18n="answersHint">Nhập đáp án đúng cho mỗi câu theo số thứ tự</p>
                    <p class="upload-hint" data-i18n="uploadHint">Hỗ trợ: Excel (.xlsx, .xls), Word (.docx), Text (.txt)</p>
                </div>

                <div class="controls">
                    <div class="quiz-settings-group">
                        <div class="setting-row">
                            <label for="questionCount" data-i18n="questionCountLabel">Số câu hỏi:</label>
                            <input type="number" id="questionCount" min="1" placeholder="Tất cả" style="width: 100px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <span class="hint-text" data-i18n="questionCountHint">(Để trống = tất cả)</span>
                        </div>
                        <div class="setting-row">
                            <label data-i18n="questionOrderLabel">Thứ tự câu hỏi:</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="questionOrder" value="sequential" checked onchange="toggleStartQuestionInput()">
                                    <span data-i18n="orderSequential">Trình tự</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="questionOrder" value="random" onchange="toggleStartQuestionInput()">
                                    <span data-i18n="orderRandom">Ngẫu nhiên</span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-row" id="startQuestionRow" style="display: flex;">
                            <label for="startQuestion" data-i18n="startQuestionLabel">Bắt đầu từ câu:</label>
                            <input type="number" id="startQuestion" min="1" value="1" placeholder="1" style="width: 100px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <span class="hint-text" data-i18n="startQuestionHint">(Chỉ với Trình tự)</span>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="shuffleCheckbox">
                        <label for="shuffleCheckbox" data-i18n="shuffleLabel">Xáo trộn câu hỏi</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="shuffleChoicesCheckbox">
                        <label for="shuffleChoicesCheckbox" data-i18n="shuffleChoicesLabel">Xáo trộn đáp án (a,b,c,d)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="practiceModeCheckbox">
                        <label for="practiceModeCheckbox" data-i18n="practiceModeLabel">🎯 Chế độ ôn tập (Hiện đáp án ngay)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="examModeCheckbox" onchange="toggleExamMode()">
                        <label for="examModeCheckbox" data-i18n="enableExamMode">⏱️ Bật chế độ thi</label>
                    </div>
                    <div class="timer-input-group" id="timerInputGroup" style="display: none;">
                        <label for="timerHours" data-i18n="hours">Giờ:</label>
                        <input type="number" id="timerHours" min="0" max="23" value="0" />
                        <label for="timerMinutes" data-i18n="minutes">Phút:</label>
                        <input type="number" id="timerMinutes" min="0" max="59" value="30" />
                    </div>
                    <button class="btn-primary" onclick="generateQuiz()" data-i18n="createQuizBtn">Tạo Quiz</button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="section hidden" id="quizSection">
                <!-- Sidebar Toggle Button -->
                <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
                    ☰
                </button>

                <!-- Focus Mode Toggle Button -->
                <button class="focus-mode-btn" id="focusModeBtn" onclick="toggleFocusMode()" title="Focus Mode">
                    🎯
                </button>

                <!-- Quiz Layout with Navigator -->
                <div class="quiz-layout">
                    <!-- Question Navigator Sidebar -->
                    <div class="question-navigator" id="questionNavigator">
                        <div class="navigator-header">
                            <span data-i18n="questionNavigator">Danh Sách Câu Hỏi</span>
                            <span class="navigator-close-btn" onclick="toggleSidebar()">✕</span>
                        </div>

                        <!-- Question Navigation List -->
                        <div class="navigator-content" id="navigatorContent">
                            <div class="question-nav-list" id="questionNavList">
                                <!-- Question nav items will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Main Quiz Content -->
                    <div class="quiz-main-content">
                        <!-- Progress Bar -->
                        <div class="progress-container" id="progressContainer" style="display: none;">
                            <div class="progress-info">
                                <span data-i18n="progressLabel">Tiến độ:</span>
                                <span id="progressText">0/0 câu</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" id="progressBarFill"></div>
                            </div>
                        </div>

                        <!-- Filter Section -->
                        <div class="filter-section" id="filterSection" style="display: none;">
                            <label style="margin-bottom: 10px;" data-i18n="filterLabel">Lọc câu hỏi:</label>
                            <div class="filter-buttons">
                                <button class="filter-button active" onclick="filterQuestions('all')" data-i18n="filterAll">Tất cả</button>
                                <button class="filter-button" onclick="filterQuestions('pinned')" data-i18n="filterPinned">Câu đã pin</button>
                                <button class="filter-button" onclick="filterQuestions('incorrect')" data-i18n="filterIncorrect">Câu sai</button>
                            </div>
                        </div>

                        <div id="quizContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden"></div>

            <!-- Statistics Button -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="stats-button" onclick="toggleStatistics()" id="statsToggleBtn">
                    📊 <span data-i18n="viewStatistics">Xem Thống Kê</span>
                </button>
            </div>

            <!-- Statistics Section -->
            <div class="statistics-section hidden" id="statisticsSection">
                <h2>📊 <span data-i18n="statisticsTitle">Thống Kê & Lịch Sử</span></h2>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats cards will be inserted here -->
                </div>

                <h3 style="margin: 30px 0 15px 0; color: var(--text-primary);">
                    <span data-i18n="recentHistory">Lịch Sử Gần Đây</span>
                </h3>
                <div id="historyTableContainer">
                    <!-- History table will be inserted here -->
                </div>

                <button class="clear-history-btn" onclick="clearHistory()">
                    🗑️ <span data-i18n="clearHistory">Xóa Lịch Sử</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>
                Made with ❤️ by <a href="https://github.com/BlueCloudK" target="_blank" rel="noopener noreferrer">BlueCloudK</a>
            </p>
            <p>
                <a href="https://github.com/BlueCloudK/Quiz-for-learning" target="_blank" rel="noopener noreferrer">
                    ⭐ Star on GitHub
                </a>
                <span class="separator">|</span>
                📧 thanhkiennk@gmail.com
            </p>
        </div>
    </footer>

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTopBtn" onclick="scrollToTop()" title="Scroll to top">
        ⬆️
    </button>

    <script>
        let quizData = [];
        let correctAnswers = {};
        let questionMapping = {}; // Lưu mapping giữa vị trí hiện tại và số thứ tự gốc
        let pinnedQuestions = new Set(); // Lưu index các câu được pin
        let incorrectQuestions = new Set(); // Lưu index các câu sai
        let answeredQuestions = new Set(); // Track câu đã trả lời (cho progress bar)
        let isGraded = false; // Track xem đã chấm điểm chưa
        let originalQuestionsText = ''; // Lưu câu hỏi gốc
        let originalAnswersText = ''; // Lưu đáp án gốc
        let currentFilter = 'all'; // Bộ lọc hiện tại
        let currentLanguage = 'vi'; // Ngôn ngữ hiện tại
        let quizHistory = []; // Lưu lịch sử làm bài
        let practiceModeEnabled = false; // Practice mode with instant feedback

        // Exam Mode variables
        let examModeEnabled = false;
        let timerInterval = null;
        let timeRemaining = 0; // in seconds

        // LocalStorage keys
        const STORAGE_KEYS = {
            QUESTIONS: 'quiz_questions',
            ANSWERS: 'quiz_answers',
            PINNED: 'quiz_pinned',
            LANGUAGE: 'quiz_language',
            HISTORY: 'quiz_history',
            THEME: 'quiz_theme',
            SAVED_QUIZZES: 'quiz_saved_sets',
            QUIZ_PROGRESS: 'quiz_progress' // Auto-save progress
        };

        // LocalStorage helper functions
        function saveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                return defaultValue;
            }
        }

        function clearStorage(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Failed to clear from localStorage:', e);
            }
        }

        // Auto-save functions
        function autoSaveQuestions() {
            const questionsText = document.getElementById('questionsInput').value;
            if (questionsText.trim()) {
                saveToStorage(STORAGE_KEYS.QUESTIONS, questionsText);
            }
        }

        function autoSaveAnswers() {
            const answersText = document.getElementById('answersInput').value;
            if (answersText.trim()) {
                saveToStorage(STORAGE_KEYS.ANSWERS, answersText);
            }
        }

        function savePinnedQuestions() {
            saveToStorage(STORAGE_KEYS.PINNED, Array.from(pinnedQuestions));
        }

        function saveLanguage(lang) {
            saveToStorage(STORAGE_KEYS.LANGUAGE, lang);
        }

        function saveQuizHistory(score, total, correct, incorrect, unanswered) {
            const historyEntry = {
                date: new Date().toISOString(),
                score: score,
                total: total,
                correct: correct,
                incorrect: incorrect,
                unanswered: unanswered,
                questionsCount: total
            };

            quizHistory.unshift(historyEntry); // Add to beginning
            if (quizHistory.length > 50) { // Keep last 50 attempts
                quizHistory = quizHistory.slice(0, 50);
            }

            saveToStorage(STORAGE_KEYS.HISTORY, quizHistory);
        }

        // Load data from localStorage
        function loadSavedData() {
            // Load language preference
            const savedLanguage = loadFromStorage(STORAGE_KEYS.LANGUAGE, 'vi');
            currentLanguage = savedLanguage;

            // Load questions and answers
            const savedQuestions = loadFromStorage(STORAGE_KEYS.QUESTIONS, '');
            const savedAnswers = loadFromStorage(STORAGE_KEYS.ANSWERS, '');

            if (savedQuestions) {
                document.getElementById('questionsInput').value = savedQuestions;
            }

            if (savedAnswers) {
                document.getElementById('answersInput').value = savedAnswers;
            }

            // Load pinned questions
            const savedPinned = loadFromStorage(STORAGE_KEYS.PINNED, []);
            pinnedQuestions = new Set(savedPinned);

            // Load quiz history
            quizHistory = loadFromStorage(STORAGE_KEYS.HISTORY, []);

            // Load theme
            const savedTheme = loadFromStorage(STORAGE_KEYS.THEME, 'light');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeToggleIcon();
            }
        }

        // Dark Mode functions
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            saveToStorage(STORAGE_KEYS.THEME, isDark ? 'dark' : 'light');
            updateThemeToggleIcon();
        }

        function updateThemeToggleIcon() {
            const themeToggle = document.getElementById('themeToggle');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? '☀️' : '🌙';
            themeToggle.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        }

        // Exam Mode functions
        function toggleExamMode() {
            examModeEnabled = document.getElementById('examModeCheckbox').checked;
            const timerInputGroup = document.getElementById('timerInputGroup');

            if (examModeEnabled) {
                // Show timer input fields
                timerInputGroup.style.display = 'flex';
            } else {
                // Hide timer input fields and stop timer if running
                timerInputGroup.style.display = 'none';
                if (timerInterval) {
                    stopTimer();
                }
            }
        }

        function toggleStartQuestionInput() {
            const questionOrder = document.querySelector('input[name="questionOrder"]:checked')?.value;
            const startQuestionRow = document.getElementById('startQuestionRow');

            if (questionOrder === 'sequential') {
                // Show start question input for sequential mode
                startQuestionRow.style.display = 'flex';
            } else {
                // Hide for random mode
                startQuestionRow.style.display = 'none';
            }
        }

        function startTimer() {
            updateTimerDisplay();
            // Show pause button when timer starts
            document.getElementById('pauseTimerBtn').style.display = 'block';
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert(translations[currentLanguage].timeUp);
                    submitQuiz();
                    return;
                }

                timeRemaining--;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            // Hide pause button when timer stops
            document.getElementById('pauseTimerBtn').style.display = 'none';
        }

        // Pause/Resume timer functionality
        let timerPaused = false;

        function togglePauseTimer() {
            const pauseIcon = document.getElementById('pauseIcon');
            const pauseText = document.getElementById('pauseText');

            if (timerPaused) {
                // Resume timer
                startTimer();
                timerPaused = false;
                pauseIcon.textContent = '⏸️';
                pauseText.textContent = translations[currentLanguage].pauseTimer || 'Tạm dừng';
            } else {
                // Pause timer
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                timerPaused = true;
                pauseIcon.textContent = '▶️';
                pauseText.textContent = translations[currentLanguage].resumeTimer || 'Tiếp tục';
            }
        }

        function updateTimerDisplay() {
            const fixedTimerText = document.getElementById('fixedTimerText');
            const formattedTime = formatTime(timeRemaining);

            fixedTimerText.textContent = formattedTime;

            // Add warning/danger classes
            fixedTimerText.classList.remove('warning', 'danger');

            if (timeRemaining <= 60) {
                fixedTimerText.classList.add('danger');
            } else if (timeRemaining <= 300) {
                fixedTimerText.classList.add('warning');
            }
        }

        function formatTime(seconds) {
            // Ensure non-negative time display
            const time = Math.max(0, seconds);
            const hours = Math.floor(time / 3600);
            const mins = Math.floor((time % 3600) / 60);
            const secs = time % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Quiz Management functions
        function saveQuizSet() {
            const quizName = document.getElementById('quizNameInput').value.trim();
            const questionsText = document.getElementById('questionsInput').value.trim();
            const answersText = document.getElementById('answersInput').value.trim();

            if (!quizName) {
                alert(translations[currentLanguage].alertNoQuizName);
                return;
            }

            if (!questionsText || !answersText) {
                alert(translations[currentLanguage].alertNoData);
                return;
            }

            // Get existing saved quizzes
            const savedQuizzes = loadFromStorage(STORAGE_KEYS.SAVED_QUIZZES, []);

            // Create new quiz object
            const newQuiz = {
                id: Date.now(),
                name: quizName,
                questions: questionsText,
                answers: answersText,
                questionCount: parseQuestions(questionsText).length,
                savedDate: new Date().toISOString()
            };

            // Add to saved quizzes
            savedQuizzes.unshift(newQuiz);

            // Save to storage
            saveToStorage(STORAGE_KEYS.SAVED_QUIZZES, savedQuizzes);

            // Clear quiz name input
            document.getElementById('quizNameInput').value = '';

            // Refresh display
            displaySavedQuizzes();

            alert(translations[currentLanguage].alertQuizSaved);
        }

        function loadQuizSet(quizId) {
            const savedQuizzes = loadFromStorage(STORAGE_KEYS.SAVED_QUIZZES, []);
            const quiz = savedQuizzes.find(q => q.id === quizId);

            if (quiz) {
                document.getElementById('questionsInput').value = quiz.questions;
                document.getElementById('answersInput').value = quiz.answers;

                // Auto-save to current storage
                autoSaveQuestions();
                autoSaveAnswers();

                // Scroll to input section
                document.getElementById('inputSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteQuizSet(quizId) {
            if (confirm(translations[currentLanguage].confirmDelete)) {
                let savedQuizzes = loadFromStorage(STORAGE_KEYS.SAVED_QUIZZES, []);
                savedQuizzes = savedQuizzes.filter(q => q.id !== quizId);
                saveToStorage(STORAGE_KEYS.SAVED_QUIZZES, savedQuizzes);
                displaySavedQuizzes();
            }
        }

        function displaySavedQuizzes() {
            const container = document.getElementById('savedQuizzesList');
            const savedQuizzes = loadFromStorage(STORAGE_KEYS.SAVED_QUIZZES, []);

            if (savedQuizzes.length === 0) {
                container.innerHTML = `<p style="color: white; text-align: center; padding: 20px;">${translations[currentLanguage].noSavedQuizzes}</p>`;
                return;
            }

            container.innerHTML = savedQuizzes.map(quiz => {
                const date = new Date(quiz.savedDate);
                const dateStr = date.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="saved-quiz-item">
                        <div class="saved-quiz-info">
                            <div class="saved-quiz-name">${quiz.name}</div>
                            <div class="saved-quiz-meta">${quiz.questionCount} ${translations[currentLanguage].questions} • ${translations[currentLanguage].savedOn} ${dateStr}</div>
                        </div>
                        <div class="saved-quiz-actions">
                            <button class="btn-load" onclick="loadQuizSet(${quiz.id})">${translations[currentLanguage].loadBtn}</button>
                            <button class="btn-delete" onclick="deleteQuizSet(${quiz.id})">${translations[currentLanguage].deleteBtn}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Statistics functions
        function toggleStatistics() {
            const statsSection = document.getElementById('statisticsSection');
            const statsBtn = document.getElementById('statsToggleBtn');
            const isHidden = statsSection.classList.contains('hidden');

            if (isHidden) {
                statsSection.classList.remove('hidden');
                statsBtn.innerHTML = `📊 <span data-i18n="hideStatistics">${translations[currentLanguage].hideStatistics}</span>`;
                displayStatistics();
                statsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                statsSection.classList.add('hidden');
                statsBtn.innerHTML = `📊 <span data-i18n="viewStatistics">${translations[currentLanguage].viewStatistics}</span>`;
            }
        }

        function displayStatistics() {
            const history = quizHistory;

            if (history.length === 0) {
                document.getElementById('statsGrid').innerHTML = `
                    <p style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);">
                        ${translations[currentLanguage].noHistory}
                    </p>
                `;
                document.getElementById('historyTableContainer').innerHTML = '';
                return;
            }

            // Calculate statistics
            const totalAttempts = history.length;
            const scores = history.map(h => parseFloat(h.score));
            const averageScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
            const highestScore = Math.max(...scores).toFixed(1);
            const lowestScore = Math.min(...scores).toFixed(1);

            // Display stat cards
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">${translations[currentLanguage].totalAttempts}</div>
                    <div class="stat-value">${totalAttempts}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">${translations[currentLanguage].averageScore}</div>
                    <div class="stat-value">${averageScore}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">${translations[currentLanguage].highestScore}</div>
                    <div class="stat-value">${highestScore}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">${translations[currentLanguage].lowestScore}</div>
                    <div class="stat-value">${lowestScore}%</div>
                </div>
            `;

            // Display history table
            const historyTableContainer = document.getElementById('historyTableContainer');
            historyTableContainer.innerHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>${translations[currentLanguage].date}</th>
                            <th>${translations[currentLanguage].score}</th>
                            <th>${translations[currentLanguage].totalQuestions}</th>
                            <th>${translations[currentLanguage].correctAnswers}</th>
                            <th>${translations[currentLanguage].incorrectAnswers}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(entry => {
                            const date = new Date(entry.date);
                            const dateStr = date.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            const scoreBadgeClass = getScoreBadgeClass(entry.score);

                            return `
                                <tr>
                                    <td>${dateStr}</td>
                                    <td><span class="score-badge ${scoreBadgeClass}">${entry.score}%</span></td>
                                    <td>${entry.total}</td>
                                    <td style="color: #4caf50; font-weight: 600;">${entry.correct}</td>
                                    <td style="color: #ff5722; font-weight: 600;">${entry.incorrect}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function getScoreBadgeClass(score) {
            const s = parseFloat(score);
            if (s >= 90) return 'score-excellent';
            if (s >= 70) return 'score-good';
            if (s >= 50) return 'score-average';
            return 'score-poor';
        }

        function clearHistory() {
            if (confirm(translations[currentLanguage].confirmClearHistory)) {
                quizHistory = [];
                saveToStorage(STORAGE_KEYS.HISTORY, []);
                displayStatistics();
            }
        }

        // Translations
        const translations = {
            vi: {
                title: '📝 BlueQuiz',
                subtitle: 'Tạo bộ câu hỏi, xáo trộn và chấm điểm tự động',
                step1: 'Bước 1: Nhập Dữ Liệu',
                step2: 'Bước 2: Làm Bài Quiz',
                questionsLabel: 'Câu hỏi và đáp án:',
                questionsPlaceholder: 'Nhập câu hỏi theo định dạng:\n\n1. Câu hỏi thứ nhất?\na. Đáp án A\nb. Đáp án B\nc. Đáp án C\nd. Đáp án D\n\n2. Câu hỏi thứ hai?\na. Đáp án A\nb. Đáp án B\nc. Đáp án C\nd. Đáp án D',
                questionsHint: 'Mỗi câu hỏi bắt đầu bằng số thứ tự, các đáp án bắt đầu bằng a, b, c, d...',
                importFileBtn: 'Import từ file',
                addImageBtn: 'Thêm ảnh',
                exportTxtBtn: 'Export TXT',
                exportExcelBtn: 'Export Excel',
                uploadHint: 'Hỗ trợ: Excel (.xlsx, .xls), Word (.docx), Text (.txt)',
                imageHint: 'Thêm ảnh: Chọn ảnh từ máy tính, tag [IMG:...] sẽ được thêm vào vị trí con trỏ',
                answersLabel: 'Đáp án đúng:',
                answersPlaceholder: 'Nhập đáp án theo định dạng:\n\n1. a\n2. b\n3. c\n4. d\n\nNhiều đáp án đúng:\n5. a,b,c\n6. abc',
                answersHint: 'Nhập đáp án đúng cho mỗi câu. Nhiều đáp án: dùng dấu phẩy (a,b,c) hoặc viết liền (abc)',
                questionCountLabel: 'Số câu hỏi:',
                questionCountHint: '(Để trống = tất cả)',
                startQuestionLabel: 'Bắt đầu từ câu:',
                startQuestionHint: '(Chỉ với Trình tự)',
                questionOrderLabel: 'Thứ tự câu hỏi:',
                orderSequential: 'Trình tự',
                orderRandom: 'Ngẫu nhiên',
                shuffleLabel: 'Xáo trộn câu hỏi',
                shuffleChoicesLabel: 'Xáo trộn đáp án (a,b,c,d)',
                practiceModeLabel: '🎯 Chế độ ôn tập (Hiện đáp án ngay)',
                createQuizBtn: 'Tạo Quiz',
                filterLabel: 'Lọc câu hỏi:',
                filterAll: 'Tất cả',
                filterPinned: 'Câu đã pin',
                filterIncorrect: 'Câu sai',
                progressLabel: 'Tiến độ:',
                submitBtn: 'Chấm Điểm',
                backToEditBtn: '⬅️ Quay Lại',
                restartBtn: '🔄 Làm Lại',
                retryAllBtn: '🔄 Làm Lại Tất Cả',
                retryIncorrectBtn: 'Làm Lại Câu Sai',
                retryPinnedBtn: 'Làm Lại Câu Đã Pin',
                questionNavigator: 'Danh Sách Câu Hỏi',
                timeRemaining: 'Thời gian còn lại:',
                pauseTimer: 'Tạm dừng',
                resumeTimer: 'Tiếp tục',
                confirmBackToEdit: 'Bạn có chắc muốn quay lại? Tiến trình làm bài sẽ KHÔNG được lưu.',
                confirmRestart: 'Bạn có chắc muốn làm lại? Bài làm hiện tại sẽ bị xóa.',
                question: 'Câu',
                pinQuestion: 'Pin câu hỏi',
                unpinQuestion: 'Bỏ pin',
                correct: '✓ Chính xác!',
                incorrect: '✗ Sai - Đáp án đúng:',
                unanswered: 'Chưa trả lời - Đáp án đúng:',
                resultTitle: '🎉 Kết Quả Của Bạn',
                totalQuestions: 'Tổng câu',
                correctAnswers: 'Đúng',
                incorrectAnswers: 'Sai',
                unansweredQuestions: 'Chưa trả lời',
                alertNoData: 'Vui lòng nhập đầy đủ câu hỏi và đáp án!',
                alertNoQuestions: 'Không tìm thấy câu hỏi hợp lệ! Vui lòng kiểm tra định dạng.',
                alertNoIncorrect: 'Không có câu sai nào để làm lại!',
                alertNoPinned: 'Chưa có câu hỏi nào được pin!',
                alertNoRetry: 'Không có câu hỏi nào để làm lại!',
                aiPromptsTitle: 'Hướng Dẫn Tạo Câu Hỏi Với AI Chatbot',
                aiPromptsDesc: 'Copy các prompt sau và paste vào ChatGPT, Claude, hoặc AI chatbot khác để tự động tạo câu hỏi đúng format:',
                quickTemplatesTitle: '📋 Hoặc Copy Template Mẫu Để Paste Trực Tiếp:',
                templateQuestionsLabel: 'Mẫu Câu Hỏi:',
                templateAnswersLabel: 'Mẫu Đáp Án:',
                templateListItemsLabel: 'Mẫu List Items:',
                copyBtn: 'Copy',
                copiedBtn: '✓ Đã copy!',
                examMode: 'Chế độ thi',
                enableExamMode: 'Bật chế độ thi',
                hours: 'Giờ:',
                minutes: 'Phút:',
                timerPanelHeader: '⏱️ Thời Gian',
                controlPanelHeader: '🎮 Điều Khiển',
                timeUp: 'Hết giờ! Tự động nộp bài...',
                examModeActive: 'Chế độ thi đang bật. Bạn không thể xem đáp án cho đến khi hết giờ hoặc nộp bài.',
                quizManagement: 'Quản Lý Bộ Quiz',
                quizNamePlaceholder: 'Nhập tên bộ quiz (VD: Lịch Sử Việt Nam, JavaScript Basics...)',
                saveQuizBtn: '💾 Lưu Bộ Quiz',
                loadBtn: 'Tải',
                deleteBtn: 'Xóa',
                questions: 'câu hỏi',
                savedOn: 'Lưu lúc:',
                confirmDelete: 'Bạn có chắc muốn xóa bộ quiz này?',
                alertNoQuizName: 'Vui lòng nhập tên bộ quiz!',
                alertNoData: 'Vui lòng nhập câu hỏi và đáp án trước khi lưu!',
                alertQuizSaved: 'Đã lưu bộ quiz thành công!',
                noSavedQuizzes: 'Chưa có bộ quiz nào được lưu',
                viewStatistics: 'Xem Thống Kê',
                hideStatistics: 'Ẩn Thống Kê',
                statisticsTitle: 'Thống Kê & Lịch Sử',
                recentHistory: 'Lịch Sử Gần Đây',
                clearHistory: 'Xóa Lịch Sử',
                confirmClearHistory: 'Bạn có chắc muốn xóa toàn bộ lịch sử?',
                totalAttempts: 'Tổng lượt thi',
                averageScore: 'Điểm TB',
                highestScore: 'Điểm cao nhất',
                lowestScore: 'Điểm thấp nhất',
                date: 'Ngày giờ',
                score: 'Điểm',
                noHistory: 'Chưa có lịch sử làm bài nào'
            },
            en: {
                title: '📝 BlueQuiz',
                subtitle: 'Create quizzes, shuffle questions, and auto-grade',
                step1: 'Step 1: Input Data',
                step2: 'Step 2: Take the Quiz',
                questionsLabel: 'Questions and Answers:',
                questionsPlaceholder: 'Enter questions in this format:\n\n1. First question?\na. Answer A\nb. Answer B\nc. Answer C\nd. Answer D\n\n2. Second question?\na. Answer A\nb. Answer B\nc. Answer C\nd. Answer D',
                questionsHint: 'Each question starts with a number, answers start with a, b, c, d...',
                importFileBtn: 'Import from file',
                addImageBtn: 'Add image',
                exportTxtBtn: 'Export TXT',
                exportExcelBtn: 'Export Excel',
                uploadHint: 'Supported: Excel (.xlsx, .xls), Word (.docx), Text (.txt)',
                imageHint: 'Add image: Select image from computer, [IMG:...] tag will be inserted at cursor position',
                answersLabel: 'Correct Answers:',
                answersPlaceholder: 'Enter answers in this format:\n\n1. a\n2. b\n3. c\n4. d\n\nMultiple correct answers:\n5. a,b,c\n6. abc',
                answersHint: 'Enter correct answers for each question. Multiple answers: use comma (a,b,c) or write together (abc)',
                questionCountLabel: 'Number of questions:',
                questionCountHint: '(Leave empty = all)',
                startQuestionLabel: 'Start from question:',
                startQuestionHint: '(Sequential only)',
                questionOrderLabel: 'Question order:',
                orderSequential: 'Sequential',
                orderRandom: 'Random',
                shuffleLabel: 'Shuffle questions',
                shuffleChoicesLabel: 'Shuffle answer choices (a,b,c,d)',
                practiceModeLabel: '🎯 Practice Mode (Instant feedback)',
                createQuizBtn: 'Create Quiz',
                filterLabel: 'Filter questions:',
                filterAll: 'All',
                filterPinned: 'Pinned',
                filterIncorrect: 'Incorrect',
                progressLabel: 'Progress:',
                submitBtn: 'Submit & Grade',
                backToEditBtn: '⬅️ Back',
                restartBtn: '🔄 Restart',
                retryAllBtn: '🔄 Retry All Questions',
                retryIncorrectBtn: 'Retry Incorrect',
                retryPinnedBtn: 'Retry Pinned',
                questionNavigator: 'Question List',
                timeRemaining: 'Time Remaining:',
                pauseTimer: 'Pause',
                resumeTimer: 'Resume',
                confirmBackToEdit: 'Are you sure you want to go back? Your progress will NOT be saved.',
                confirmRestart: 'Are you sure you want to restart? Your current answers will be cleared.',
                question: 'Question',
                pinQuestion: 'Pin question',
                unpinQuestion: 'Unpin',
                correct: '✓ Correct!',
                incorrect: '✗ Incorrect - Correct answer:',
                unanswered: 'Not answered - Correct answer:',
                resultTitle: '🎉 Your Results',
                totalQuestions: 'Total',
                correctAnswers: 'Correct',
                incorrectAnswers: 'Incorrect',
                unansweredQuestions: 'Not Answered',
                alertNoData: 'Please enter both questions and answers!',
                alertNoQuestions: 'No valid questions found! Please check the format.',
                alertNoIncorrect: 'No incorrect questions to retry!',
                alertNoPinned: 'No questions have been pinned yet!',
                alertNoRetry: 'No questions to retry!',
                aiPromptsTitle: 'Generate Questions With AI Chatbot',
                aiPromptsDesc: 'Copy these prompts and paste into ChatGPT, Claude, or other AI chatbots to automatically generate questions in the correct format:',
                quickTemplatesTitle: '📋 Or Copy Sample Templates to Paste Directly:',
                templateQuestionsLabel: 'Questions Template:',
                templateAnswersLabel: 'Answers Template:',
                templateListItemsLabel: 'List Items Template:',
                copyBtn: 'Copy',
                copiedBtn: '✓ Copied!',
                examMode: 'Exam Mode',
                enableExamMode: 'Enable exam mode',
                hours: 'Hours:',
                minutes: 'Minutes:',
                timerPanelHeader: '⏱️ Timer',
                controlPanelHeader: '🎮 Controls',
                timeUp: 'Time\'s up! Auto-submitting...',
                examModeActive: 'Exam mode is active. You cannot see answers until time expires or you submit.',
                quizManagement: 'Quiz Management',
                quizNamePlaceholder: 'Enter quiz name (e.g., World History, JavaScript Basics...)',
                saveQuizBtn: '💾 Save Quiz Set',
                loadBtn: 'Load',
                deleteBtn: 'Delete',
                questions: 'questions',
                savedOn: 'Saved on:',
                confirmDelete: 'Are you sure you want to delete this quiz set?',
                alertNoQuizName: 'Please enter a quiz name!',
                alertNoData: 'Please enter questions and answers before saving!',
                alertQuizSaved: 'Quiz set saved successfully!',
                noSavedQuizzes: 'No saved quiz sets yet',
                viewStatistics: 'View Statistics',
                hideStatistics: 'Hide Statistics',
                statisticsTitle: 'Statistics & History',
                recentHistory: 'Recent History',
                clearHistory: 'Clear History',
                confirmClearHistory: 'Are you sure you want to clear all history?',
                totalAttempts: 'Total Attempts',
                averageScore: 'Avg Score',
                highestScore: 'Highest Score',
                lowestScore: 'Lowest Score',
                date: 'Date & Time',
                score: 'Score',
                noHistory: 'No quiz history yet'
            }
        };

        // Template data for quick copy
        const templates = {
            vi: {
                questions: `1. Câu hỏi thứ nhất?
a. Đáp án A
b. Đáp án B
c. Đáp án C
d. Đáp án D

2. Câu hỏi thứ hai?
a. Đáp án A
b. Đáp án B
c. Đáp án C
d. Đáp án D

3. Câu hỏi thứ ba (nhiều đáp án đúng)?
a. Lựa chọn A
b. Lựa chọn B
c. Lựa chọn C
d. Lựa chọn D
e. Lựa chọn E`,
                answers: `1. a
2. b
3. a,c,e`,
                listItems: `Các hoạt động nào sau đây là chính trong quy trình review?
- 1. Lập kế hoạch
- 2. Review cá nhân
- 3. Họp nhóm
- 4. Sửa lỗi
- 5. Tài liệu hóa
- 6. Kiểm thử

A. 1, 2, 4
B. 2, 3, 5
C. 1, 2, 3, 4
D. Tất cả các mục`
            },
            en: {
                questions: `1. First question?
a. Answer A
b. Answer B
c. Answer C
d. Answer D

2. Second question?
a. Answer A
b. Answer B
c. Answer C
d. Answer D

3. Third question (multiple correct answers)?
a. Option A
b. Option B
c. Option C
d. Option D
e. Option E`,
                answers: `1. a
2. b
3. a,c,e`,
                listItems: `Which of the following are main activities in the review process?
- 1. Planning
- 2. Individual review
- 3. Team meeting
- 4. Code fixing
- 5. Documentation
- 6. Testing

A. 1, 2, 4
B. 2, 3, 5
C. 1, 2, 3, 4
D. All items`
            }
        };

        // AI Prompts templates
        const aiPrompts = {
            vi: [
                {
                    title: '📚 Tạo Bộ Câu Hỏi Về Chủ Đề Bất Kỳ',
                    description: 'Tạo 10 câu hỏi trắc nghiệm về chủ đề bạn muốn học',
                    prompt: `Hãy tạo 10 câu hỏi trắc nghiệm về [TOPIC] theo định dạng sau:

1. [Câu hỏi]
a. [Đáp án A]
b. [Đáp án B]
c. [Đáp án C]
d. [Đáp án D]

Sau đó, cung cấp đáp án đúng theo format:
1. [đáp án đúng]

Ví dụ:
1. Python là ngôn ngữ lập trình gì?
a. Compiled
b. Interpreted
c. Assembly
d. Machine code

Đáp án:
1. b

[Thay TOPIC bằng chủ đề của bạn, ví dụ: Lịch sử Việt Nam, Toán học lớp 10, JavaScript, etc.]`
                },
                {
                    title: '🎓 Ôn Tập Kỳ Thi',
                    description: 'Tạo câu hỏi ôn tập dựa trên nội dung cụ thể',
                    prompt: `Dựa trên nội dung sau đây, tạo 10 câu hỏi trắc nghiệm:

[PASTE CONTENT Ở ĐÂY]

Định dạng câu hỏi:
1. [Câu hỏi]
a. [Đáp án A]
b. [Đáp án B]
c. [Đáp án C]
d. [Đáp án D]

Định dạng đáp án:
1. [a/b/c/d]

Lưu ý:
- Câu hỏi phải kiểm tra sự hiểu biết, không chỉ ghi nhớ
- Các đáp án sai phải hợp lý và gây nhầm lẫn
- Đảm bảo chỉ có 1 đáp án đúng`
                },
                {
                    title: '💡 Câu Hỏi Nhiều Đáp Án Đúng',
                    description: 'Tạo câu hỏi có nhiều đáp án đúng (checkbox)',
                    prompt: `Tạo 5 câu hỏi về [TOPIC] mà mỗi câu có NHIỀU đáp án đúng:

Định dạng câu hỏi:
1. [Câu hỏi] (chọn tất cả đáp án đúng)
a. [Đáp án A]
b. [Đáp án B]
c. [Đáp án C]
d. [Đáp án D]
e. [Đáp án E]

Định dạng đáp án (nhiều đáp án đúng):
1. a,c,e
hoặc
1. ace

Ví dụ:
1. Ngôn ngữ nào sau đây hỗ trợ lập trình hướng đối tượng?
a. Python
b. Java
c. C
d. JavaScript
e. Assembly

Đáp án:
1. a,b,d`
                },
                {
                    title: '🌍 Học Ngoại Ngữ',
                    description: 'Tạo bài tập từ vựng và ngữ pháp',
                    prompt: `Tạo 10 câu hỏi trắc nghiệm học [NGÔN NGỮ]:

5 câu đầu: Từ vựng (nghĩa của từ)
5 câu sau: Ngữ pháp (điền từ đúng vào chỗ trống)

Định dạng:
1. [Câu hỏi]
a. [Đáp án A]
b. [Đáp án B]
c. [Đáp án C]
d. [Đáp án D]

Đáp án:
1. [a/b/c/d]

Ví dụ về từ vựng:
1. "Beautiful" có nghĩa là gì?
a. Xấu
b. Đẹp
c. Tốt
d. Cao

Ví dụ về ngữ pháp:
2. She ___ to school every day.
a. go
b. goes
c. going
d. went

Đáp án:
1. b
2. b`
                },
                {
                    title: '🧪 Khoa Học & Công Nghệ',
                    description: 'Câu hỏi khoa học với nhiều lựa chọn',
                    prompt: `Tạo 10 câu hỏi khoa học về [TOPIC] với 5-6 lựa chọn cho mỗi câu:

Định dạng:
1. [Câu hỏi]
a. [Đáp án A]
b. [Đáp án B]
c. [Đáp án C]
d. [Đáp án D]
e. [Đáp án E]
f. [Đáp án F] (nếu cần)

Đáp án:
1. [a/b/c/d/e/f]

Yêu cầu:
- Độ khó: trung bình đến khó
- Bao gồm cả câu hỏi lý thuyết và ứng dụng
- Đáp án sai phải hợp lý về mặt khoa học`
                },
                {
                    title: '📋 Câu Hỏi Với Danh Sách (List Items)',
                    description: 'Tạo câu hỏi có danh sách mục liệt kê',
                    prompt: `Tạo 5 câu hỏi về [TOPIC] với danh sách các mục được liệt kê:

Định dạng:
[Câu hỏi]?
- 1. [Mục thứ nhất]
- 2. [Mục thứ hai]
- 3. [Mục thứ ba]
- 4. [Mục thứ tư]
- 5. [Mục thứ năm]
- 6. [Mục thứ sáu]

A. 1, 2, 4
B. 2, 3, 5
C. 1, 3, 4, 6
D. Tất cả các mục

Lưu ý QUAN TRỌNG:
- Sử dụng CHỮ HOA (A, B, C, D) cho các lựa chọn khi có danh sách liệt kê
- Mỗi lựa chọn tham chiếu đến các số trong danh sách
- Câu hỏi và danh sách liệt kê trước, sau đó mới đến các lựa chọn A, B, C, D

Ví dụ:
Which of the following are main activities of code review?
- 1. Planning
- 2. Individual review
- 3. Team meeting
- 4. Code fixing
- 5. Documentation
- 6. Testing

A. 1, 2, 4
B. 2, 3, 5
C. 1, 2, 3, 4
D. All items

Đáp án:
1. C`
                }
            ],
            en: [
                {
                    title: '📚 Create Quiz on Any Topic',
                    description: 'Generate 10 multiple choice questions about any subject',
                    prompt: `Create 10 multiple choice questions about [TOPIC] in this format:

1. [Question]
a. [Answer A]
b. [Answer B]
c. [Answer C]
d. [Answer D]

Then provide correct answers in this format:
1. [correct answer]

Example:
1. What type of programming language is Python?
a. Compiled
b. Interpreted
c. Assembly
d. Machine code

Answers:
1. b

[Replace TOPIC with your subject, e.g.: World History, Calculus, JavaScript, etc.]`
                },
                {
                    title: '🎓 Exam Review',
                    description: 'Create review questions based on specific content',
                    prompt: `Based on the following content, create 10 multiple choice questions:

[PASTE CONTENT HERE]

Question format:
1. [Question]
a. [Answer A]
b. [Answer B]
c. [Answer C]
d. [Answer D]

Answer format:
1. [a/b/c/d]

Note:
- Questions should test understanding, not just memorization
- Wrong answers should be plausible and challenging
- Ensure only one correct answer`
                },
                {
                    title: '💡 Multiple Correct Answers',
                    description: 'Create questions with multiple correct answers (checkbox)',
                    prompt: `Create 5 questions about [TOPIC] where each has MULTIPLE correct answers:

Question format:
1. [Question] (select all that apply)
a. [Answer A]
b. [Answer B]
c. [Answer C]
d. [Answer D]
e. [Answer E]

Answer format (multiple correct):
1. a,c,e
or
1. ace

Example:
1. Which languages support object-oriented programming?
a. Python
b. Java
c. C
d. JavaScript
e. Assembly

Answers:
1. a,b,d`
                },
                {
                    title: '🌍 Language Learning',
                    description: 'Create vocabulary and grammar exercises',
                    prompt: `Create 10 multiple choice questions for learning [LANGUAGE]:

First 5: Vocabulary (word meanings)
Last 5: Grammar (fill in the blank)

Format:
1. [Question]
a. [Answer A]
b. [Answer B]
c. [Answer C]
d. [Answer D]

Answers:
1. [a/b/c/d]

Vocabulary example:
1. What does "Beautiful" mean?
a. Ugly
b. Pretty
c. Good
d. Tall

Grammar example:
2. She ___ to school every day.
a. go
b. goes
c. going
d. went

Answers:
1. b
2. b`
                },
                {
                    title: '🧪 Science & Technology',
                    description: 'Science questions with more options',
                    prompt: `Create 10 science questions about [TOPIC] with 5-6 options each:

Format:
1. [Question]
a. [Answer A]
b. [Answer B]
c. [Answer C]
d. [Answer D]
e. [Answer E]
f. [Answer F] (if needed)

Answers:
1. [a/b/c/d/e/f]

Requirements:
- Difficulty: medium to hard
- Include both theoretical and applied questions
- Wrong answers should be scientifically plausible`
                },
                {
                    title: '📋 Questions With List Items',
                    description: 'Create questions with enumerated list items',
                    prompt: `Create 5 questions about [TOPIC] with numbered list items:

Format:
[Question]?
- 1. [First item]
- 2. [Second item]
- 3. [Third item]
- 4. [Fourth item]
- 5. [Fifth item]
- 6. [Sixth item]

A. 1, 2, 4
B. 2, 3, 5
C. 1, 3, 4, 6
D. All items

IMPORTANT Notes:
- Use UPPERCASE letters (A, B, C, D) for options when using list items
- Each option references numbers from the list
- Question and list items come first, then options A, B, C, D

Example:
Which of the following are main activities of code review?
- 1. Planning
- 2. Individual review
- 3. Team meeting
- 4. Code fixing
- 5. Documentation
- 6. Testing

A. 1, 2, 4
B. 2, 3, 5
C. 1, 2, 3, 4
D. All items

Answers:
1. C`
                }
            ]
        };

        function changeLanguage(lang) {
            currentLanguage = lang;
            saveLanguage(lang); // Save language preference

            // Update language button active state
            document.querySelectorAll('.language-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = lang === 'vi' ? document.getElementById('langVi') : document.getElementById('langEn');
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Update all elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Update pin button titles if quiz is displayed
            if (!document.getElementById('quizSection').classList.contains('hidden')) {
                quizData.forEach((q, index) => {
                    const originalNumber = questionMapping[index];
                    const isPinned = pinnedQuestions.has(originalNumber);
                    const pinButton = document.getElementById(`pin${index}`);
                    if (pinButton) {
                        pinButton.title = isPinned ? translations[lang].unpinQuestion : translations[lang].pinQuestion;
                    }
                });
            }

            // Update result section if it exists
            if (isGraded && !document.getElementById('resultSection').classList.contains('hidden')) {
                // Re-display results with new language
                const resultDiv = document.getElementById('resultSection');
                if (resultDiv.innerHTML) {
                    // Results will be updated on next submit
                }
            }

            // Re-render AI prompts with new language
            renderAIPrompts();

            // Update templates
            updateTemplates();

            // Update saved quizzes display
            displaySavedQuizzes();
        }

        function updateTemplates() {
            const questionsTemplate = document.getElementById('questionsTemplate');
            const answersTemplate = document.getElementById('answersTemplate');
            const listItemsTemplate = document.getElementById('listItemsTemplate');

            if (questionsTemplate && answersTemplate) {
                questionsTemplate.textContent = templates[currentLanguage].questions;
                answersTemplate.textContent = templates[currentLanguage].answers;
            }

            if (listItemsTemplate) {
                listItemsTemplate.textContent = templates[currentLanguage].listItems;
            }
        }

        // Initialize language on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData(); // Load saved data from localStorage
            changeLanguage(currentLanguage); // Use saved language or default
            renderAIPrompts();
            displaySavedQuizzes(); // Display saved quiz sets

            // Add auto-save event listeners
            const questionsInput = document.getElementById('questionsInput');
            const answersInput = document.getElementById('answersInput');

            // Auto-save on input with debounce
            let questionsSaveTimer;
            let answersSaveTimer;

            questionsInput.addEventListener('input', function() {
                clearTimeout(questionsSaveTimer);
                questionsSaveTimer = setTimeout(autoSaveQuestions, 1000);
            });

            answersInput.addEventListener('input', function() {
                clearTimeout(answersSaveTimer);
                answersSaveTimer = setTimeout(autoSaveAnswers, 1000);
            });

            // Also save on blur (when user clicks away)
            questionsInput.addEventListener('blur', autoSaveQuestions);
            answersInput.addEventListener('blur', autoSaveAnswers);
        });

        function toggleAIPrompts() {
            const content = document.getElementById('aiPromptsContent');
            const icon = document.getElementById('toggleIcon');

            content.classList.toggle('expanded');
            icon.classList.toggle('rotated');
        }

        function renderAIPrompts() {
            const container = document.getElementById('promptsContainer');
            const prompts = aiPrompts[currentLanguage];

            container.innerHTML = prompts.map((prompt, index) => `
                <div class="prompt-card">
                    <h4>${prompt.title}</h4>
                    <p>${prompt.description}</p>
                    <div class="prompt-text" id="prompt${index}">${prompt.prompt}</div>
                    <button class="copy-btn" onclick="copyPrompt(${index})" id="copyBtn${index}">
                        <span>${translations[currentLanguage].copyBtn}</span>
                    </button>
                </div>
            `).join('');
        }

        function copyPrompt(index) {
            const promptText = aiPrompts[currentLanguage][index].prompt;
            const button = document.getElementById(`copyBtn${index}`);

            navigator.clipboard.writeText(promptText).then(() => {
                button.classList.add('copied');
                button.innerHTML = `<span>${translations[currentLanguage].copiedBtn}</span>`;

                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = `<span>${translations[currentLanguage].copyBtn}</span>`;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Không thể copy. Vui lòng copy thủ công.');
            });
        }

        function copyTemplate(type) {
            const templateText = templates[currentLanguage][type];
            const button = document.getElementById(`copy${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);

            navigator.clipboard.writeText(templateText).then(() => {
                const originalHTML = button.innerHTML;
                button.classList.add('copied');
                button.innerHTML = `<span>${translations[currentLanguage].copiedBtn}</span>`;

                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Không thể copy. Vui lòng copy thủ công.');
            });
        }

        function parseQuestions(text) {
            const questions = [];
            const lines = text.trim().split('\n');
            let currentQuestion = null;
            let questionNumber = 0;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Format 1: Câu hỏi bắt đầu bằng số (1. 2. 3.)
                const numberedQuestionMatch = line.match(/^(\d+)\.\s*(.+)/);
                if (numberedQuestionMatch) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    questionNumber = parseInt(numberedQuestionMatch[1]);
                    currentQuestion = {
                        number: questionNumber,
                        question: numberedQuestionMatch[2],
                        options: []
                    };
                    continue;
                }

                // Kiểm tra dòng đáp án (a. b. c. hoặc A. B. C.)
                const optionMatch = line.match(/^([a-zA-Z])\.\s*(.+)/);
                if (optionMatch && currentQuestion) {
                    currentQuestion.options.push({
                        letter: optionMatch[1].toLowerCase(),
                        text: optionMatch[2]
                    });
                    continue;
                }

                // Format 2: Câu hỏi không có số (dòng text, thường kết thúc bằng ?)
                // Chỉ coi là câu hỏi mới nếu chưa có currentQuestion hoặc đã có đáp án
                if (line.includes('?') && (!currentQuestion || currentQuestion.options.length > 0)) {
                    if (currentQuestion && currentQuestion.options.length > 0) {
                        questions.push(currentQuestion);
                    }
                    questionNumber++;
                    currentQuestion = {
                        number: questionNumber,
                        question: line,
                        options: []
                    };
                    continue;
                }

                // Các dòng khác (list items: - 1., - I., etc) -> append vào câu hỏi
                if (currentQuestion && currentQuestion.options.length === 0) {
                    currentQuestion.question += '\n' + line;
                }
            }

            if (currentQuestion && currentQuestion.options.length > 0) {
                questions.push(currentQuestion);
            }

            return questions;
        }

        function parseAnswers(text) {
            const answers = {};
            const lines = text.trim().split(/[\n]+/);

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Match pattern: 1. a hoặc 1. a,b,c hoặc 1. abc hoặc 1.a 1.b 1.c
                const match = line.match(/^(\d+)\.\s*(.+)/);
                if (match) {
                    const questionNum = parseInt(match[1]);
                    let answerPart = match[2].trim();

                    // Xử lý các format: "a,b,c" hoặc "abc" hoặc "a b c"
                    answerPart = answerPart.replace(/\s+/g, ''); // Remove spaces

                    // Nếu có dấu phẩy, split by comma
                    if (answerPart.includes(',')) {
                        answers[questionNum] = answerPart.split(',').map(a => a.toLowerCase().trim());
                    } else if (answerPart.length > 1 && /^[a-z]+$/i.test(answerPart)) {
                        // Nếu là chuỗi nhiều chữ cái liên tiếp (abc)
                        answers[questionNum] = answerPart.toLowerCase().split('');
                    } else {
                        // Đáp án đơn
                        answers[questionNum] = answerPart.toLowerCase();
                    }
                }
            }

            return answers;
        }

        function isMultipleAnswer(questionNumber) {
            const answer = correctAnswers[questionNumber];
            return Array.isArray(answer);
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function shuffleQuestionChoices(questions, answers) {
            // Shuffle choices for each question and update correct answers
            const letters = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];

            questions.forEach(q => {
                if (q.options && q.options.length > 0) {
                    // Create mapping of old letter to new letter
                    const oldLetters = q.options.map(opt => opt.letter);

                    // Shuffle options
                    const shuffledOptions = shuffleArray([...q.options]);

                    // Create letter mapping
                    const letterMapping = {};
                    shuffledOptions.forEach((opt, index) => {
                        letterMapping[opt.letter] = letters[index];
                        opt.letter = letters[index]; // Update letter in option
                    });

                    // Update question options
                    q.options = shuffledOptions;

                    // Update correct answer for this question
                    const correctAnswer = answers[q.number];
                    if (correctAnswer) {
                        if (Array.isArray(correctAnswer)) {
                            // Multiple answers
                            answers[q.number] = correctAnswer.map(letter => letterMapping[letter] || letter);
                        } else {
                            // Single answer
                            answers[q.number] = letterMapping[correctAnswer] || correctAnswer;
                        }
                    }
                }
            });
        }

        function generateQuiz(specificQuestions = null) {
            let questionsText, answersText;

            if (specificQuestions) {
                // Tạo quiz từ câu hỏi cụ thể (pin hoặc sai)
                questionsText = originalQuestionsText;
                answersText = originalAnswersText;
            } else {
                // Tạo quiz mới từ input
                questionsText = document.getElementById('questionsInput').value;
                answersText = document.getElementById('answersInput').value;
                originalQuestionsText = questionsText;
                originalAnswersText = answersText;
                pinnedQuestions.clear();
                incorrectQuestions.clear();
                isGraded = false;
                clearQuizProgress(); // Clear saved progress when starting new quiz
            }

            const shouldShuffle = document.getElementById('shuffleCheckbox').checked;

            if (!questionsText.trim() || !answersText.trim()) {
                alert(translations[currentLanguage].alertNoData);
                return;
            }

            // Parse dữ liệu
            let allQuestions = parseQuestions(questionsText);
            correctAnswers = parseAnswers(answersText);

            if (allQuestions.length === 0) {
                alert(translations[currentLanguage].alertNoQuestions);
                return;
            }

            // Lọc câu hỏi nếu có specificQuestions
            if (specificQuestions) {
                quizData = allQuestions.filter(q => specificQuestions.has(q.number));
                if (quizData.length === 0) {
                    alert(translations[currentLanguage].alertNoRetry);
                    return;
                }
            } else {
                quizData = allQuestions;

                const questionOrder = document.querySelector('input[name="questionOrder"]:checked')?.value || 'sequential';

                if (questionOrder === 'random') {
                    // Chọn NGẪU NHIÊN: xáo toàn bộ trước, sau đó lấy N câu
                    quizData = shuffleArray([...quizData]);

                    // Áp dụng số lượng câu hỏi
                    const questionCountInput = document.getElementById('questionCount');
                    const questionCount = parseInt(questionCountInput?.value);
                    if (questionCount && questionCount > 0 && questionCount < quizData.length) {
                        quizData = quizData.slice(0, questionCount);
                    }
                } else {
                    // Chọn TRÌNH TỰ: lấy từ câu bắt đầu
                    const startQuestionInput = document.getElementById('startQuestion');
                    const startQuestion = parseInt(startQuestionInput?.value) || 1;
                    const startIndex = Math.max(0, startQuestion - 1); // Convert to 0-based index

                    const questionCountInput = document.getElementById('questionCount');
                    const questionCount = parseInt(questionCountInput?.value);

                    // Bắt đầu từ câu startQuestion
                    if (startIndex > 0 || questionCount) {
                        const endIndex = questionCount && questionCount > 0
                            ? Math.min(startIndex + questionCount, quizData.length)
                            : quizData.length;
                        quizData = quizData.slice(startIndex, endIndex);
                    }

                    // Sau đó nếu có checkbox "Xáo trộn đề" thì mới xáo
                    if (shouldShuffle) {
                        quizData = shuffleArray([...quizData]);
                    }
                }
            }

            // Shuffle choices if enabled
            const shouldShuffleChoices = document.getElementById('shuffleChoicesCheckbox').checked;
            if (shouldShuffleChoices) {
                shuffleQuestionChoices(quizData, correctAnswers);
            }

            // Tạo mapping
            questionMapping = {};
            quizData.forEach((q, index) => {
                questionMapping[index] = q.number;
            });

            // Reset trạng thái
            isGraded = false;
            document.getElementById('retryIncorrectBtn').classList.add('hidden');
            document.getElementById('retryPinnedBtn').classList.add('hidden');
            document.getElementById('filterSection').style.display = 'none';

            // Start timer if exam mode is enabled
            if (examModeEnabled) {
                // Stop any existing timer first to prevent multiple intervals
                stopTimer();
                const hours = parseInt(document.getElementById('timerHours').value) || 0;
                const minutes = parseInt(document.getElementById('timerMinutes').value) || 30;
                timeRemaining = (hours * 3600) + (minutes * 60);
                startTimer();
            }

            // Hiển thị quiz
            displayQuiz();
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');

            // Show and reset progress bar
            document.getElementById('progressContainer').style.display = 'block';
            resetProgressBar();

            // Check if practice mode is enabled
            practiceModeEnabled = document.getElementById('practiceModeCheckbox').checked;

            // Ẩn AI prompts section khi vào quiz mode
            const aiPromptsSection = document.querySelector('.ai-prompts-section');
            if (aiPromptsSection) {
                aiPromptsSection.style.display = 'none';
            }

            // Scroll to top of page
            window.scrollTo(0, 0);
        }

        // Parse [IMG:...] tags and convert to HTML <img> tags
        function parseQuestionImages(questionText) {
            // Replace [IMGx:filename] placeholders with actual images from storage
            let result = questionText.replace(/\[(IMG\d+):[^\]]+\]/g, (match, imageId) => {
                const base64 = imageStorage[imageId];
                if (base64) {
                    return `<img src="${base64}" class="question-image" alt="Question image" onclick="openImageModal(this.src)" />`;
                }
                return match; // Keep original if not found
            });

            // Also support old format [IMG:data:image...] for backward compatibility
            result = result.replace(/\[IMG:(data:image[^\]]+)\]/g, (match, src) => {
                return `<img src="${src}" class="question-image" alt="Question image" onclick="openImageModal(this.src)" />`;
            });

            return result;
        }

        // Open image in modal for full-size viewing
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden'; // Prevent background scroll
        }

        // Close image modal
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function displayQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';

            quizData.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.id = `card${index}`;

                // Check nếu câu này đã được pin
                const originalNumber = q.number;
                const isPinned = pinnedQuestions.has(originalNumber);
                const isIncorrect = incorrectQuestions.has(originalNumber);

                if (isPinned) {
                    questionCard.classList.add('pinned');
                }

                // Parse images in question text
                const questionWithImages = parseQuestionImages(q.question);

                let html = `
                    <div class="question-header-container">
                        <div class="question-header">${translations[currentLanguage].question} ${index + 1}</div>
                        <button class="pin-button ${isPinned ? 'pinned' : 'unpinned'}"
                                onclick="togglePin(${index})"
                                id="pin${index}"
                                title="${isPinned ? translations[currentLanguage].unpinQuestion : translations[currentLanguage].pinQuestion}">
                            ${isPinned ? '📌' : '📍'}
                        </button>
                    </div>
                    <div class="question-text">${questionWithImages}</div>
                    <div class="options">
                `;

                const isMultiple = isMultipleAnswer(originalNumber);
                const inputType = isMultiple ? 'checkbox' : 'radio';

                q.options.forEach(option => {
                    html += `
                        <div class="option">
                            <input type="${inputType}"
                                   name="question${index}"
                                   value="${option.letter}"
                                   id="q${index}_${option.letter}">
                            <label for="q${index}_${option.letter}">
                                ${option.letter.toUpperCase()}. ${option.text}
                            </label>
                        </div>
                    `;
                });

                html += `
                    </div>
                    <div class="question-result hidden" id="result${index}"></div>
                `;

                questionCard.innerHTML = html;
                container.appendChild(questionCard);
            });

            // Generate question navigator
            generateQuestionNavigator();

            // Setup answer change listeners
            setupAnswerListeners();

            // Restore saved progress
            restoreQuizProgress();

            // Enable inputs when displaying quiz (in case coming from retry)
            enableQuizInputs();

            // Scroll to top of quiz section
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function togglePin(index) {
            const originalNumber = questionMapping[index];
            const pinButton = document.getElementById(`pin${index}`);
            const card = document.getElementById(`card${index}`);

            if (pinnedQuestions.has(originalNumber)) {
                pinnedQuestions.delete(originalNumber);
                pinButton.classList.remove('pinned');
                pinButton.classList.add('unpinned');
                pinButton.textContent = '📍';
                pinButton.title = translations[currentLanguage].pinQuestion;
                card.classList.remove('pinned');
            } else {
                pinnedQuestions.add(originalNumber);
                pinButton.classList.remove('unpinned');
                pinButton.classList.add('pinned');
                pinButton.textContent = '📌';
                pinButton.title = translations[currentLanguage].unpinQuestion;
                card.classList.add('pinned');
            }

            // Save pinned questions to localStorage
            savePinnedQuestions();

            // Update navigator to show pinned status
            updateQuestionNavigator();

            // Update button visibility
            updateRetryButtons();
        }

        function submitQuiz() {
            // Stop timer if exam mode is active but keep exam mode enabled for restart
            if (examModeEnabled) {
                stopTimer();
            }

            let correctCount = 0;
            let incorrectCount = 0;
            let unanswered = 0;

            // Clear previous incorrect questions
            incorrectQuestions.clear();

            quizData.forEach((q, index) => {
                const originalNumber = questionMapping[index];
                const resultDiv = document.getElementById(`result${index}`);
                resultDiv.classList.remove('hidden');

                const isMultiple = isMultipleAnswer(originalNumber);
                let userAnswer;
                let isCorrect = false;

                if (isMultiple) {
                    // Checkbox - multiple answers
                    const selectedOptions = document.querySelectorAll(`input[name="question${index}"]:checked`);
                    if (selectedOptions.length === 0) {
                        userAnswer = null;
                    } else {
                        userAnswer = Array.from(selectedOptions).map(opt => opt.value).sort();
                        const correctAnswer = correctAnswers[originalNumber].slice().sort();

                        // So sánh arrays
                        isCorrect = userAnswer.length === correctAnswer.length &&
                                   userAnswer.every((val, idx) => val === correctAnswer[idx]);
                    }
                } else {
                    // Radio - single answer
                    const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                    if (!selectedOption) {
                        userAnswer = null;
                    } else {
                        userAnswer = selectedOption.value;
                        isCorrect = userAnswer === correctAnswers[originalNumber];
                    }
                }

                // Display result
                if (userAnswer === null) {
                    const correctAnswerDisplay = Array.isArray(correctAnswers[originalNumber])
                        ? correctAnswers[originalNumber].map(a => a.toUpperCase()).join(', ')
                        : correctAnswers[originalNumber].toUpperCase();
                    resultDiv.className = 'question-result incorrect';
                    resultDiv.textContent = `${translations[currentLanguage].unanswered} ${correctAnswerDisplay}`;
                    unanswered++;
                    incorrectCount++;
                    incorrectQuestions.add(originalNumber);
                } else if (isCorrect) {
                    resultDiv.className = 'question-result correct';
                    resultDiv.textContent = translations[currentLanguage].correct;
                    correctCount++;
                } else {
                    const correctAnswerDisplay = Array.isArray(correctAnswers[originalNumber])
                        ? correctAnswers[originalNumber].map(a => a.toUpperCase()).join(', ')
                        : correctAnswers[originalNumber].toUpperCase();
                    resultDiv.className = 'question-result incorrect';
                    resultDiv.textContent = `${translations[currentLanguage].incorrect} ${correctAnswerDisplay}`;
                    incorrectCount++;
                    incorrectQuestions.add(originalNumber);
                }
            });

            isGraded = true;
            displayResults(correctCount, incorrectCount, unanswered);
            updateRetryButtons();
            updateQuestionNavigator(); // Update navigator with results

            // Disable all inputs after grading
            disableQuizInputs();

            // Show filter section after grading
            if (isGraded) {
                document.getElementById('filterSection').style.display = 'block';

                // Reset filter to 'all' and set active button
                currentFilter = 'all';
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Set first button (All) as active
                const allButton = document.querySelector('.filter-button[onclick*="all"]');
                if (allButton) {
                    allButton.classList.add('active');
                }

                // Show all questions
                quizData.forEach((q, index) => {
                    const card = document.getElementById(`card${index}`);
                    if (card) {
                        card.style.display = 'block';
                    }
                });
            }

            // Clear auto-saved progress after submitting
            clearQuizProgress();

            // Scroll to top of page
            window.scrollTo(0, 0);
        }

        function disableQuizInputs() {
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.disabled = true;
            });
        }

        function enableQuizInputs() {
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.disabled = false;
            });
        }

        function updateRetryButtons() {
            const retryAllBtn = document.getElementById('retryAllBtn');
            const retryIncorrectBtn = document.getElementById('retryIncorrectBtn');
            const retryPinnedBtn = document.getElementById('retryPinnedBtn');

            // Only show retry buttons after quiz is graded
            if (isGraded) {
                retryAllBtn.classList.remove('hidden');
            } else {
                retryAllBtn.classList.add('hidden');
            }

            if (isGraded && incorrectQuestions.size > 0) {
                retryIncorrectBtn.classList.remove('hidden');
            } else {
                retryIncorrectBtn.classList.add('hidden');
            }

            if (isGraded && pinnedQuestions.size > 0) {
                retryPinnedBtn.classList.remove('hidden');
            } else {
                retryPinnedBtn.classList.add('hidden');
            }
        }

        function displayResults(correct, incorrect, unanswered) {
            const total = quizData.length;
            const percentage = ((correct / total) * 100).toFixed(1);

            // Save to quiz history
            saveQuizHistory(percentage, total, correct, incorrect, unanswered);

            const resultSection = document.getElementById('resultSection');
            resultSection.innerHTML = `
                <h2>${translations[currentLanguage].resultTitle}</h2>
                <div class="score-display">${percentage}%</div>
                <div class="result-details">
                    <div class="result-item">
                        <h3>${translations[currentLanguage].totalQuestions}</h3>
                        <p>${total}</p>
                    </div>
                    <div class="result-item">
                        <h3>${translations[currentLanguage].correctAnswers}</h3>
                        <p style="color: #38ef7d;">${correct}</p>
                    </div>
                    <div class="result-item">
                        <h3>${translations[currentLanguage].incorrectAnswers}</h3>
                        <p style="color: #ff6b6b;">${incorrect}</p>
                    </div>
                    ${unanswered > 0 ? `
                    <div class="result-item">
                        <h3>${translations[currentLanguage].unansweredQuestions}</h3>
                        <p style="color: #ffd93d;">${unanswered}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            resultSection.classList.remove('hidden');

            // Scroll to results
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function backToEdit() {
            // Confirm before going back (will NOT save progress)
            if (!confirm(translations[currentLanguage].confirmBackToEdit)) {
                return;
            }

            // Stop timer if running
            if (examModeEnabled) {
                stopTimer();
                examModeEnabled = false;
                document.getElementById('examModeCheckbox').checked = false;
                document.getElementById('fixedRightTimer').classList.remove('active');
                document.getElementById('timerHours').disabled = false;
                document.getElementById('timerMinutes').disabled = false;
            }

            // Hide all quiz panels
            const navigator = document.getElementById('questionNavigator');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const fixedControlPanel = document.getElementById('fixedControlPanel');

            navigator.classList.remove('active');
            navigator.classList.remove('open');
            sidebarToggleBtn.classList.remove('active');
            fixedControlPanel.classList.remove('active');

            // Ensure fixedControlPanel is completely hidden
            if (fixedControlPanel) {
                fixedControlPanel.style.display = 'none';
            }

            // Show input section, hide quiz and result sections
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');

            // Hiện lại AI prompts section khi quay về edit mode
            const aiPromptsSection = document.querySelector('.ai-prompts-section');
            if (aiPromptsSection) {
                aiPromptsSection.style.display = 'block';
            }

            // Scroll to input section
            document.getElementById('inputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function restartQuiz() {
            // Confirm before restarting
            if (!confirm(translations[currentLanguage].confirmRestart)) {
                return;
            }

            // Reset timer to original time if exam mode is enabled
            if (examModeEnabled) {
                stopTimer();
                const hours = parseInt(document.getElementById('timerHours').value) || 0;
                const minutes = parseInt(document.getElementById('timerMinutes').value) || 30;
                timeRemaining = (hours * 3600) + (minutes * 60);
                startTimer();
            }

            // Clear answers but keep questions
            isGraded = false;
            incorrectQuestions.clear();

            // Clear all answer selections and enable inputs
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.checked = false;
            });
            enableQuizInputs();

            // Clear result displays
            document.querySelectorAll('.question-result').forEach(result => {
                result.classList.add('hidden');
            });

            // Hide result section and retry buttons
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('retryIncorrectBtn').classList.add('hidden');
            document.getElementById('filterSection').style.display = 'none';

            // Update navigator
            updateQuestionNavigator();

            // Scroll to top of quiz
            document.getElementById('quizSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Question Navigator functions
        function generateQuestionNavigator() {
            const navList = document.getElementById('questionNavList');
            navList.innerHTML = '';

            quizData.forEach((q, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'question-nav-item';
                navItem.id = `nav-q${index}`;
                navItem.textContent = index + 1;
                navItem.onclick = () => navigateToQuestion(index);
                navList.appendChild(navItem);
            });

            // Show navigator and toggle button
            document.getElementById('questionNavigator').classList.add('active');
            document.getElementById('sidebarToggleBtn').classList.add('active');
            document.getElementById('focusModeBtn').classList.add('active');

            // Show fixed right timer and control panel if exam mode enabled
            if (examModeEnabled) {
                document.getElementById('fixedRightTimer').classList.add('active');
            }

            // Always show control panel when quiz is displayed
            const controlPanel = document.getElementById('fixedControlPanel');
            controlPanel.classList.add('active');
            controlPanel.style.display = ''; // Clear inline style

            // Initial update to show pinned status
            updateQuestionNavigator();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('questionNavigator');
            sidebar.classList.toggle('open');
        }

        function toggleFocusMode() {
            document.body.classList.toggle('focus-mode');
            const focusBtn = document.getElementById('focusModeBtn');
            focusBtn.classList.toggle('focused');

            // Update button title
            if (document.body.classList.contains('focus-mode')) {
                focusBtn.title = 'Exit Focus Mode';
            } else {
                focusBtn.title = 'Focus Mode';
            }
        }

        function updateQuestionNavigator() {
            quizData.forEach((q, index) => {
                const navItem = document.getElementById(`nav-q${index}`);
                if (!navItem) return;

                // Reset classes
                navItem.className = 'question-nav-item';

                // Check if answered
                const originalNumber = questionMapping[index];
                const isPinned = pinnedQuestions.has(originalNumber);
                const isMultiple = isMultipleAnswer(originalNumber);
                let isAnswered = false;

                if (isMultiple) {
                    const selectedOptions = document.querySelectorAll(`input[name="question${index}"]:checked`);
                    isAnswered = selectedOptions.length > 0;
                } else {
                    const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                    isAnswered = selectedOption !== null;
                }

                // Add pinned class if this question is pinned
                if (isPinned) {
                    navItem.classList.add('pinned');
                }

                if (isAnswered) {
                    navItem.classList.add('answered');
                }

                // If graded, show correct/incorrect
                if (isGraded) {
                    if (incorrectQuestions.has(originalNumber)) {
                        navItem.classList.remove('answered');
                        navItem.classList.add('incorrect');
                    } else {
                        navItem.classList.remove('answered');
                        navItem.classList.add('correct');
                    }
                }
            });
        }

        function navigateToQuestion(index) {
            const questionCard = document.getElementById(`card${index}`);
            if (questionCard) {
                // Remove current highlight from all nav items
                document.querySelectorAll('.question-nav-item').forEach(item => {
                    item.classList.remove('current');
                });

                // Add current highlight
                const navItem = document.getElementById(`nav-q${index}`);
                if (navItem) {
                    navItem.classList.add('current');
                }

                // Scroll to question
                questionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove highlight after 2 seconds
                setTimeout(() => {
                    if (navItem) {
                        navItem.classList.remove('current');
                    }
                }, 2000);
            }
        }

        // Setup answer change listeners
        function setupAnswerListeners() {
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    updateQuestionNavigator();
                    updateProgressBar(e);

                    // Practice mode: show instant feedback
                    if (practiceModeEnabled) {
                        showInstantFeedback(e);
                    }

                    // Auto-save progress
                    saveQuizProgress();
                });
            });
        }

        function saveQuizProgress() {
            const progress = {};
            quizData.forEach((q, index) => {
                const inputs = document.querySelectorAll(`input[name="question${index}"]:checked`);
                if (inputs.length > 0) {
                    progress[index] = Array.from(inputs).map(input => input.value);
                }
            });
            saveToStorage(STORAGE_KEYS.QUIZ_PROGRESS, progress);
        }

        function restoreQuizProgress() {
            const progress = getFromStorage(STORAGE_KEYS.QUIZ_PROGRESS);
            if (!progress) return;

            Object.keys(progress).forEach(questionIndex => {
                const answers = progress[questionIndex];
                answers.forEach(answer => {
                    const input = document.getElementById(`q${questionIndex}_${answer}`);
                    if (input) {
                        input.checked = true;
                        // Trigger change event to update progress bar
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
            });
        }

        function clearQuizProgress() {
            localStorage.removeItem(STORAGE_KEYS.QUIZ_PROGRESS);
        }

        function showInstantFeedback(event) {
            // Extract question index from input name
            const questionIndex = parseInt(event.target.name.replace('question', ''));
            const originalNumber = questionMapping[questionIndex];
            const resultDiv = document.getElementById(`result${questionIndex}`);

            // Get user's answer
            const isMultiple = isMultipleAnswer(originalNumber);
            let userAnswer;
            let isCorrect = false;

            if (isMultiple) {
                const selectedOptions = document.querySelectorAll(`input[name="question${questionIndex}"]:checked`);
                if (selectedOptions.length === 0) {
                    resultDiv.classList.add('hidden');
                    return;
                }
                userAnswer = Array.from(selectedOptions).map(opt => opt.value).sort();
                const correctAnswer = correctAnswers[originalNumber].slice().sort();
                isCorrect = userAnswer.length === correctAnswer.length &&
                           userAnswer.every((val, idx) => val === correctAnswer[idx]);
            } else {
                const selectedOption = document.querySelector(`input[name="question${questionIndex}"]:checked`);
                if (!selectedOption) {
                    resultDiv.classList.add('hidden');
                    return;
                }
                userAnswer = selectedOption.value;
                isCorrect = userAnswer === correctAnswers[originalNumber];
            }

            // Show result
            resultDiv.classList.remove('hidden');
            if (isCorrect) {
                resultDiv.className = 'question-result correct';
                resultDiv.textContent = translations[currentLanguage].correct;
            } else {
                const correctAnswerDisplay = Array.isArray(correctAnswers[originalNumber])
                    ? correctAnswers[originalNumber].map(a => a.toUpperCase()).join(', ')
                    : correctAnswers[originalNumber].toUpperCase();
                resultDiv.className = 'question-result incorrect';
                resultDiv.textContent = `${translations[currentLanguage].incorrect} ${correctAnswerDisplay}`;
            }
        }

        function updateProgressBar(event) {
            // Extract question index from input name (e.g., "question0" -> 0)
            const questionIndex = parseInt(event.target.name.replace('question', ''));

            // Check if this question has any answer selected
            const inputType = event.target.type;
            let hasAnswer = false;

            if (inputType === 'radio') {
                // For radio, check if any radio is selected
                const selectedRadio = document.querySelector(`input[name="question${questionIndex}"]:checked`);
                hasAnswer = selectedRadio !== null;
            } else if (inputType === 'checkbox') {
                // For checkbox, check if any checkbox is checked
                const checkedBoxes = document.querySelectorAll(`input[name="question${questionIndex}"]:checked`);
                hasAnswer = checkedBoxes.length > 0;
            }

            // Update answeredQuestions set
            if (hasAnswer) {
                answeredQuestions.add(questionIndex);
            } else {
                answeredQuestions.delete(questionIndex);
            }

            // Update progress bar display
            const total = quizData ? quizData.length : 0;
            const answered = answeredQuestions.size;
            const percentage = total > 0 ? Math.round((answered / total) * 100) : 0;

            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressBarFill = document.getElementById('progressBarFill');

            if (progressText && progressPercent && progressBarFill) {
                progressText.textContent = `${answered}/${total} câu`;
                progressPercent.textContent = `${percentage}%`;
                progressBarFill.style.width = `${percentage}%`;
            }
        }

        function resetProgressBar() {
            answeredQuestions.clear();
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressBarFill = document.getElementById('progressBarFill');

            if (progressText && progressPercent && progressBarFill && quizData) {
                progressText.textContent = `0/${quizData.length} câu`;
                progressPercent.textContent = '0%';
                progressBarFill.style.width = '0%';
            }
        }

        function retryAllQuestions() {
            // Retry all original questions
            generateQuiz();
        }

        function retryIncorrectQuestions() {
            if (incorrectQuestions.size === 0) {
                alert(translations[currentLanguage].alertNoIncorrect);
                return;
            }
            generateQuiz(incorrectQuestions);
        }

        function retryPinnedQuestions() {
            if (pinnedQuestions.size === 0) {
                alert(translations[currentLanguage].alertNoPinned);
                return;
            }
            generateQuiz(pinnedQuestions);
        }

        function filterQuestions(filterType) {
            currentFilter = filterType;

            // Update active filter button
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter question cards
            quizData.forEach((q, index) => {
                const card = document.getElementById(`card${index}`);
                const originalNumber = questionMapping[index];
                let shouldShow = false;

                switch(filterType) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'pinned':
                        shouldShow = pinnedQuestions.has(originalNumber);
                        break;
                    case 'incorrect':
                        shouldShow = incorrectQuestions.has(originalNumber);
                        break;
                }

                if (shouldShow) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // File import functions
        async function handleQuestionsFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileInfo = document.getElementById('questionsFileInfo');
            fileInfo.textContent = `Đang xử lý: ${file.name}...`;

            try {
                const text = await readFile(file);
                document.getElementById('questionsInput').value = text;
                fileInfo.textContent = `✓ Đã import: ${file.name}`;
                fileInfo.style.color = '#28a745';

                // Auto-save
                autoSaveQuestions();
            } catch (error) {
                fileInfo.textContent = `✗ Lỗi: ${error.message}`;
                fileInfo.style.color = '#dc3545';
            }

            // Reset file input
            event.target.value = '';
        }

        async function handleAnswersFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileInfo = document.getElementById('answersFileInfo');
            fileInfo.textContent = `Đang xử lý: ${file.name}...`;

            try {
                const text = await readFile(file);
                document.getElementById('answersInput').value = text;
                fileInfo.textContent = `✓ Đã import: ${file.name}`;
                fileInfo.style.color = '#28a745';

                // Auto-save
                autoSaveAnswers();
            } catch (error) {
                fileInfo.textContent = `✗ Lỗi: ${error.message}`;
                fileInfo.style.color = '#dc3545';
            }

            // Reset file input
            event.target.value = '';
        }

        // Global image storage for base64 mapping
        let imageStorage = {};
        let imageCounter = 0;

        // Handle image upload and convert to base64
        async function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const textarea = document.getElementById('questionsInput');
            const fileInfo = document.getElementById('questionsFileInfo');

            try {
                fileInfo.textContent = `Đang xử lý ${files.length} ảnh...`;
                fileInfo.style.color = '#667eea';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    // Check if file is an image
                    if (!file.type.startsWith('image/')) {
                        throw new Error(`${file.name} không phải là file ảnh hợp lệ`);
                    }

                    // Convert image to base64
                    const base64 = await imageToBase64(file);

                    // Generate unique image ID
                    imageCounter++;
                    const imageId = `IMG${imageCounter}`;
                    imageStorage[imageId] = base64;

                    // Insert short placeholder tag instead of full base64
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const textAfter = textarea.value.substring(cursorPos);
                    const imageTag = `[${imageId}:${file.name}]\n`;

                    textarea.value = textBefore + imageTag + textAfter;

                    // Move cursor after inserted tag
                    const newPos = cursorPos + imageTag.length;
                    textarea.selectionStart = newPos;
                    textarea.selectionEnd = newPos;
                    textarea.focus();
                }

                fileInfo.textContent = `✓ Đã thêm ${files.length} ảnh`;
                fileInfo.style.color = '#28a745';

                // Auto-save
                autoSaveQuestions();

                setTimeout(() => {
                    fileInfo.textContent = '';
                }, 3000);
            } catch (error) {
                fileInfo.textContent = `✗ Lỗi: ${error.message}`;
                fileInfo.style.color = '#dc3545';
            }

            // Reset file input
            event.target.value = '';
        }

        // Convert image file to base64
        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve(e.target.result);
                };
                reader.onerror = () => {
                    reject(new Error(`Không thể đọc file: ${file.name}`));
                };
                reader.readAsDataURL(file);
            });
        }

        async function readFile(file) {
            const extension = file.name.split('.').pop().toLowerCase();

            if (extension === 'txt') {
                return await readTextFile(file);
            } else if (extension === 'xlsx' || extension === 'xls') {
                return await readExcelFile(file);
            } else if (extension === 'docx') {
                return await readWordFile(file);
            } else {
                throw new Error('Định dạng file không được hỗ trợ');
            }
        }

        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Không thể đọc file text'));
                reader.readAsText(file);
            });
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convert to CSV then process (better encoding handling)
                        const csv = XLSX.utils.sheet_to_csv(worksheet, { FS: '\t', RS: '\n' });

                        // Remove BOM (Byte Order Mark) if present
                        let text = csv.replace(/^\uFEFF/, ''); // UTF-8 BOM
                        text = text.replace(/^ÿþ/, '');        // UTF-16 LE BOM
                        text = text.replace(/^\xEF\xBB\xBF/, ''); // UTF-8 BOM (another form)

                        // Clean up: remove extra tabs and spaces
                        const cleaned = text.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .join('\n');

                        resolve(cleaned);
                    } catch (error) {
                        reject(new Error('Không thể đọc file Excel: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Không thể đọc file Excel'));
                reader.readAsArrayBuffer(file);
            });
        }

        function readWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mammoth.extractRawText({ arrayBuffer: e.target.result })
                        .then(result => {
                            // Clean up the text
                            const cleaned = result.value
                                .split('\n')
                                .map(line => line.trim())
                                .filter(line => line.length > 0)
                                .join('\n');
                            resolve(cleaned);
                        })
                        .catch(error => reject(new Error('Không thể đọc file Word: ' + error.message)));
                };
                reader.onerror = () => reject(new Error('Không thể đọc file Word'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Export functions
        function exportQuestions(format) {
            const text = document.getElementById('questionsInput').value;
            if (!text.trim()) {
                alert('Không có dữ liệu câu hỏi để export!');
                return;
            }

            if (format === 'txt') {
                downloadTextFile(text, 'cau-hoi.txt');
            } else if (format === 'xlsx') {
                downloadExcelFile(text, 'cau-hoi.xlsx');
            }
        }

        function exportAnswers(format) {
            const text = document.getElementById('answersInput').value;
            if (!text.trim()) {
                alert('Không có dữ liệu đáp án để export!');
                return;
            }

            if (format === 'txt') {
                downloadTextFile(text, 'dap-an.txt');
            } else if (format === 'xlsx') {
                downloadExcelFile(text, 'dap-an.xlsx');
            }
        }

        function downloadTextFile(text, filename) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadExcelFile(text, filename) {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();

            // Split text into lines and convert to array of arrays
            const lines = text.split('\n').map(line => [line]);

            // Create worksheet from the data
            const ws = XLSX.utils.aoa_to_sheet(lines);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

            // Generate Excel file and trigger download
            XLSX.writeFile(wb, filename);
        }

        // Scroll to Top functionality
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Show/hide scroll to top button based on scroll position
        window.addEventListener('scroll', function() {
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });
    </script>
</body>
</html>
